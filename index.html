<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurante Regalo de Dios - Sistema de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales y tema futurista */
        body {
            font-family: 'Roboto Mono', monospace;
            background-image: url('https://rhainaizblawiktjlwsv.supabase.co/storage/v1/object/public/logos/imagen_2025-10-10_160304895.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        h1, h2, h3 {
            font-family: 'Orbitron', sans-serif;
            color: #00bcd4;
        }
        .header-bg, .form-panel, .modal-panel {
            background-color: rgba(30, 30, 46, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 188, 212, 0.2);
            box-shadow: 0 0 20px rgba(0, 188, 212, 0.3);
        }
        .container { max-width: 1400px; }
        .order-card {
            transition: all 0.3s ease;
            border-radius: 0.75rem;
            background-color: rgba(40, 40, 60, 0.8);
            border: 1px solid rgba(0, 188, 212, 0.2);
        }
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.4);
        }
        
        /* Estilos de estado y botones */
        .status-en-espera { border-left: 6px solid #ffeb3b; }
        .status-visto { border-left: 6px solid #00bcd4; }
        .status-listo { border-left: 6px solid #4caf50; }
        .status-cerrado { border-left: 6px solid #5a5a5a; }

        .view-button {
            background-color: rgba(0, 188, 212, 0.1);
            color: #00bcd4;
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 188, 212, 0.3);
        }
        .view-button.active {
            background-color: #00bcd4;
            color: white;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.6);
        }
        .view-button:hover:not(.active) {
            background-color: rgba(0, 188, 212, 0.2);
        }

        .primary-btn {
            background-color: #00bcd4;
            color: white;
            transition: all 0.2s ease;
        }
        .primary-btn:hover {
            background-color: #00e5ff;
        }

        /* Estilos de inputs y otros elementos */
        .form-panel input, .form-panel select, .form-panel textarea {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 188, 212, 0.3);
            color: white;
        }
        .golden-text {
            color: #ffcf40;
            text-shadow: 0 0 8px #ffcf40;
        }
        .login-watermark {
            color: #e0e0e0;
            opacity: 0.2;
        }
        .status-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-icon-en-espera { background-color: #ffeb3b; }
        .status-icon-visto { background-color: #00bcd4; }
        .status-icon-listo { background-color: #4caf50; }
        .status-icon-cerrado { background-color: #5a5a5a; }

        /* Estilos para la impresión del tiquete */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: 'Courier New', monospace; font-size: 9pt; color: #000;
            }
            #print-area h1 { font-size: 12pt; text-align: center; }
            #print-area p { margin: 2px 0; }
            #print-area ul { list-style-type: none; padding: 5px 0; margin: 5px 0; border-top: 1px dashed #000; border-bottom: 1px dashed #000; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Pantalla de Contraseña -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div id="password-box" class="modal-panel p-8 rounded-lg text-center w-full max-w-sm">
            <img src="https://rhainaizblawiktjlwsv.supabase.co/storage/v1/object/public/logos/imagen_2025-10-10_160555537.png" alt="Logo Regalo de Dios" class="mx-auto h-24 w-24 object-contain rounded-full shadow-md mb-6">
            <h2 class="text-2xl font-bold mb-4 text-white">Ingresar Contraseña</h2>
            <form id="password-form">
                <input type="password" id="password-input" class="w-full p-3 rounded-md text-center bg-gray-700 text-white" placeholder="********">
                <p id="error-message" class="text-red-400 text-sm mt-2 hidden">Contraseña incorrecta.</p>
                <button type="submit" class="w-full primary-btn py-3 rounded-md text-lg font-semibold mt-6">Acceder</button>
            </form>
            <p class="login-watermark mt-4">CREADO POR FABIAN CARVAJAL</p>
        </div>
    </div>

    <!-- Panel de Administrador -->
    <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="modal-panel p-8 rounded-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-white text-center">Panel de Administrador</h2>
            <div class="space-y-4">
                <label for="admin-days-input" class="block text-sm font-medium text-blue-200">Días para ajustar el temporizador:</label>
                <input type="number" id="admin-days-input" class="w-full p-3 rounded-md bg-gray-700 text-white" placeholder="Ej: 10">
                <div class="flex space-x-4">
                    <button id="add-days-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md font-semibold">Añadir Días</button>
                    <button id="remove-days-btn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-md font-semibold">Quitar Días</button>
                </div>
                <p id="admin-feedback" class="text-green-400 text-sm mt-2 h-4 text-center"></p>
            </div>

            <div class="mt-8 border-t border-cyan-700 pt-6">
                <h3 class="text-xl font-bold mb-4 text-white text-center">Gestionar Menú</h3>
                <form id="menu-form" class="space-y-3">
                    <input type="text" id="menu-item-name" class="w-full p-2 rounded-md bg-gray-700 text-white" placeholder="Nombre del platillo" required>
                    <div class="flex space-x-2">
                        <input type="number" id="menu-item-price" class="w-1/2 p-2 rounded-md bg-gray-700 text-white" placeholder="Precio (ej: 4000)" required>
                        <select id="menu-item-category" class="w-1/2 p-2 rounded-md bg-gray-700 text-white" required>
                            <option value="" disabled selected>Categoría</option>
                            <option value="Antojitos">Antojitos</option>
                            <option value="Desayunos">Desayunos</option>
                            <option value="Combos">Combos</option>
                            <option value="Casados">Casados</option>
                            <option value="Platos Fuertes">Platos Fuertes</option>
                            <option value="Hamburguesas">Hamburguesas</option>
                            <option value="Gallos">Gallos</option>
                            <option value="Menú Niños">Menú Niños</option>
                            <option value="Bebidas">Bebidas</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-md font-semibold">Añadir al Menú</button>
                </form>
                <div id="admin-menu-list" class="mt-4 space-y-2 max-h-48 overflow-y-auto">
                    <!-- Admin menu list will be injected here -->
                </div>
            </div>

            <button id="admin-logout-btn" class="w-full bg-gray-700 text-cyan-400 hover:bg-gray-600 py-2 mt-8 rounded-md font-semibold border border-cyan-400">Volver</button>
        </div>
    </div>
    
    <!-- Modal de Confirmación -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="modal-panel p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <h2 id="confirm-title" class="text-2xl font-bold mb-4 text-white">Confirmar Acción</h2>
            <p id="confirm-message" class="text-gray-300 mb-6">¿Estás seguro?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-btn" class="px-8 py-2 bg-red-800 hover:bg-red-900 rounded-md font-semibold">Sí</button>
                <button id="confirm-no-btn" class="px-8 py-2 bg-gray-600 hover:bg-gray-700 rounded-md font-semibold">No</button>
            </div>
        </div>
    </div>

    <!-- Contenido Principal de la Aplicación -->
    <div class="container mx-auto p-4 hidden">
        <header class="header-bg rounded-lg p-6 mb-8 text-center relative">
            <div class="absolute top-4 left-4 text-left">
                <p class="text-xs font-semibold text-cyan-400">Tiempo restante:</p>
                <p id="countdown-timer" class="text-lg font-bold text-yellow-400">Cargando...</p>
            </div>
            <button id="logoutBtn" class="absolute top-4 right-4 bg-gray-700 text-cyan-400 hover:bg-gray-600 px-4 py-1.5 rounded-full text-sm font-semibold border border-cyan-400">Cerrar Sesión</button>
            <p id="live-clock" class="absolute top-12 right-4 text-xs font-semibold text-cyan-400"></p>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <img src="https://rhainaizblawiktjlwsv.supabase.co/storage/v1/object/public/logos/imagen_2025-10-10_160555537.png" alt="Logo Regalo de Dios" class="h-16 w-16 object-contain rounded-full shadow-md">
                <h1 class="text-4xl font-bold leading-tight golden-text">Restaurante Regalo de Dios</h1>
            </div>
            <div class="flex justify-center items-center mt-6 space-x-3">
                <button id="showCashierViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Vista Caja</button>
                <button id="showKitchenViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Vista Cocina</button>
                <button id="showHistoryViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Historial</button>
            </div>
             <div id="auth-status" class="text-center mt-4 text-sm text-gray-400">Conectando a Firebase...</div>
        </header>

        <!-- Vista Caja -->
        <div id="cashierView">
             <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="lg:col-span-2 lg:sticky lg:top-8">
                    <div class="form-panel p-8 rounded-lg">
                        <h2 class="text-3xl font-bold mb-6 text-center text-cyan-400">Crear Nuevo Pedido</h2>
                        <form id="orderForm" class="space-y-6">
                            <div>
                                <label for="tableNumber" class="block text-sm font-medium text-blue-200 mb-1">Número de Mesa</label>
                                <select id="tableNumber" required class="w-full bg-gray-700 text-white rounded-md p-3"></select>
                            </div>
                            <div>
                                <label for="orderItems" class="block text-sm font-medium text-blue-200 mb-1">Artículos del Pedido</label>
                                <textarea id="orderItems" rows="5" required class="w-full p-3 text-white bg-gray-700 rounded-md" placeholder="Ej:\n1 Hamburguesa\n1 Papas fritas"></textarea>
                            </div>
                             <div class="mt-4">
                                <h4 class="text-lg font-bold text-cyan-300 mb-2">Menú Rápido</h4>
                                 <div id="menu-categories" class="flex flex-wrap gap-2 border-b border-cyan-800 pb-2 mb-2">
                                    <!-- Category buttons will be injected here -->
                                </div>
                                <div id="menuItemsContainer" class="flex flex-wrap gap-2 max-h-48 overflow-y-auto">
                                    <!-- Menu items will be injected here -->
                                </div>
                            </div>
                            <button type="submit" class="w-full primary-btn py-3 rounded-md text-lg font-semibold">Enviar Pedido a Cocina</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-3">
                     <div class="form-panel p-8 rounded-lg">
                        <h3 class="text-3xl font-bold mb-6 text-center text-cyan-400">Estado de Mesas Activas</h3>
                        <div id="cashierOrders" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Cocina -->
        <div id="kitchenView" class="hidden">
            <h2 class="text-3xl font-bold mb-6 text-center text-cyan-400">Pedidos Activos en Cocina</h2>
            <div id="kitchenOrders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>

        <!-- Vista Historial -->
        <div id="historyView" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-cyan-400">Historial de Pedidos</h2>
                <button id="deleteAllHistoryBtn" class="bg-red-800 text-white px-4 py-2 rounded-md hover:bg-red-900 text-sm font-semibold">Borrar todo el historial</button>
            </div>
            <div id="historyOrders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
    </div>
    
    <!-- Área de Impresión (oculta) -->
    <div id="print-area" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs, serverTimestamp, setLogLevel, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Selectores de Elementos del DOM ---
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');
        const mainContainer = document.querySelector('.container');
        const logoutBtn = document.getElementById('logoutBtn');
        const liveClockEl = document.getElementById('live-clock');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const authStatusEl = document.getElementById('auth-status');
        
        const cashierView = document.getElementById('cashierView');
        const kitchenView = document.getElementById('kitchenView');
        const historyView = document.getElementById('historyView');
        const showCashierViewBtn = document.getElementById('showCashierViewBtn');
        const showKitchenViewBtn = document.getElementById('showKitchenViewBtn');
        const showHistoryViewBtn = document.getElementById('showHistoryViewBtn');
        
        const orderForm = document.getElementById('orderForm');
        const tableNumberSelect = document.getElementById('tableNumber');
        const orderItemsTextarea = document.getElementById('orderItems');
        const kitchenOrdersContainer = document.getElementById('kitchenOrders');
        const cashierOrdersContainer = document.getElementById('cashierOrders');
        const historyOrdersContainer = document.getElementById('historyOrders');
        const deleteAllHistoryBtn = document.getElementById('deleteAllHistoryBtn');
        
        const adminPanel = document.getElementById('admin-panel');
        const adminDaysInput = document.getElementById('admin-days-input');
        const addDaysBtn = document.getElementById('add-days-btn');
        const removeDaysBtn = document.getElementById('remove-days-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminFeedback = document.getElementById('admin-feedback');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let confirmCallback = null;
        
        // Menu selectors
        const menuItemsContainer = document.getElementById('menuItemsContainer');
        const menuForm = document.getElementById('menu-form');
        const menuItemNameInput = document.getElementById('menu-item-name');
        const menuItemPriceInput = document.getElementById('menu-item-price');
        const menuItemCategorySelect = document.getElementById('menu-item-category');
        const adminMenuList = document.getElementById('admin-menu-list');
        
        let db, auth;

        // --- Lógica de la Aplicación ---
        
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            if (password === '1234') {
                passwordModal.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                initializeFirebase();
            } else if (password === '2004') {
                passwordModal.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                 if (!db) initializeFirebase();
            }
            else {
                errorMessage.classList.remove('hidden');
                passwordInput.value = '';
            }
        });
        passwordInput.addEventListener('input', () => errorMessage.classList.add('hidden'));
        logoutBtn.addEventListener('click', () => location.reload());
        adminLogoutBtn.addEventListener('click', () => {
            adminPanel.classList.add('hidden');
            passwordModal.classList.remove('hidden');
        });

        async function initializeFirebase() {
            if (db) return; 
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig.apiKey) {
                    authStatusEl.textContent = "Error: Configuración de Firebase no encontrada.";
                    authStatusEl.style.color = '#ef4444';
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        authStatusEl.textContent = `Conectado como: ${user.uid.substring(0,6)}`;
                        authStatusEl.style.color = '#4ade80';
                        if (!mainContainer.classList.contains('hidden') || !adminPanel.classList.contains('hidden')) {
                           initializeApplication();
                        }
                    } else {
                        authStatusEl.textContent = "Autenticando...";
                        authStatusEl.style.color = '#ffeb3b';
                    }
                });
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                authStatusEl.textContent = "Error de conexión con Firebase.";
                authStatusEl.style.color = '#ef4444';
            }
        }

        function initializeApplication() {
            populateTableNumbers();
            switchView('cashier');
            updateClock();
            setInterval(updateClock, 1000);
            startCountdown();
            listenToOrders();
            listenToMenu();
        }

        function populateTableNumbers() {
            tableNumberSelect.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Mesa ${i}`;
                tableNumberSelect.appendChild(option);
            }
        }
        
        function switchView(view) {
            [cashierView, kitchenView, historyView].forEach(v => v.classList.add('hidden'));
            [showCashierViewBtn, showKitchenViewBtn, showHistoryViewBtn].forEach(b => b.classList.remove('active'));
            if (view === 'cashier') cashierView.classList.remove('hidden'), showCashierViewBtn.classList.add('active');
            else if (view === 'kitchen') kitchenView.classList.remove('hidden'), showKitchenViewBtn.classList.add('active');
            else if (view === 'history') historyView.classList.remove('hidden'), showHistoryViewBtn.classList.add('active');
        }
        showCashierViewBtn.addEventListener('click', () => switchView('cashier'));
        showKitchenViewBtn.addEventListener('click', () => switchView('kitchen'));
        showHistoryViewBtn.addEventListener('click', () => switchView('history'));

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const items = orderItemsTextarea.value.trim().split('\n').filter(Boolean);
            if (items.length === 0) return;

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionPath = `artifacts/${appId}/public/data/orders`;

                await addDoc(collection(db, collectionPath), {
                    tableNumber: parseInt(tableNumberSelect.value),
                    items: items,
                    status: 'En espera',
                    createdAt: serverTimestamp(),
                    closedAt: null
                });
                orderItemsTextarea.value = '';
            } catch (error) {
                console.error("Error al añadir pedido:", error);
            }
        });

        function listenToOrders() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/public/data/orders`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                let orders = [];
                snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
                renderAllOrders(orders);
            }, (error) => {
                console.error("Error al escuchar pedidos:", error);
            });
        }
        
        function renderAllOrders(orders) {
            kitchenOrdersContainer.innerHTML = '';
            cashierOrdersContainer.innerHTML = '';
            historyOrdersContainer.innerHTML = '';

            const activeOrders = orders.filter(o => o.status !== 'Cerrado');
            const closedOrders = orders.filter(o => o.status === 'Cerrado');
            
            if (activeOrders.length > 0) {
                 activeOrders.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); 
                activeOrders.forEach(order => {
                    kitchenOrdersContainer.appendChild(createOrderCard(order));
                    cashierOrdersContainer.appendChild(createCashierOrderCard(order));
                });
            } else {
                const noOrdersMsg = '<p class="text-center col-span-full text-gray-400 p-4">No hay pedidos activos.</p>';
                kitchenOrdersContainer.innerHTML = noOrdersMsg;
                cashierOrdersContainer.innerHTML = noOrdersMsg;
            }

            if (closedOrders.length > 0) {
                deleteAllHistoryBtn.classList.remove('hidden');
                closedOrders.sort((a, b) => (b.closedAt?.seconds || 0) - (a.closedAt?.seconds || 0));
                closedOrders.forEach(order => historyOrdersContainer.appendChild(createHistoryOrderCard(order)));
            } else {
                deleteAllHistoryBtn.classList.add('hidden');
                historyOrdersContainer.innerHTML = '<p class="text-center col-span-full text-gray-400 p-4">No hay pedidos en el historial.</p>';
            }
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card flex flex-col justify-between status-${order.status.toLowerCase().replace(' ', '-')}`;
            const statusColors = { "En espera": "bg-yellow-400 text-yellow-900", "Visto": "bg-cyan-500 text-cyan-900", "Listo": "bg-emerald-500 text-emerald-900" };
            const statusIcons = { "En espera": "status-icon-en-espera", "Visto": "status-icon-visto", "Listo": "status-icon-listo" };
            const itemsHtml = order.items.map(item => `<li class="text-gray-200">${item}</li>`).join('');
            const time = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString('es-CR') : '...';

            card.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-white">Mesa ${order.tableNumber}</h3>
                        <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${statusColors[order.status]}">
                           <span class="status-icon ${statusIcons[order.status]}"></span>${order.status}
                        </span>
                    </div>
                    <ul class="list-disc list-inside space-y-1 mb-4">${itemsHtml}</ul>
                    <p class="text-xs text-gray-400">${time}</p>
                </div>
                ${order.status !== 'Listo' ? `
                <div class="flex space-x-2 p-4 pt-0">
                    ${order.status === 'En espera' ? `<button data-id="${order.id}" data-status="Visto" class="update-status-btn flex-1 bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded-md text-sm font-semibold">Marcar Visto</button>` : ''}
                    ${order.status === 'Visto' ? `<button data-id="${order.id}" data-status="Listo" class="update-status-btn flex-1 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-md text-sm font-semibold">Marcar Listo</button>` : ''}
                </div>` : '<div class="p-4 text-center text-sm font-semibold text-emerald-500">Pedido completado</div>'}`;
            return card;
        }

        function createCashierOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card flex flex-col justify-between status-${order.status.toLowerCase().replace(' ', '-')}`;
            const itemsHtml = order.items.map(item => `<li class="text-sm text-gray-300">${item}</li>`).join('');

            card.innerHTML = `
                <div class="p-4">
                     <h3 class="text-lg font-bold text-white">Mesa ${order.tableNumber}</h3>
                     <p class="text-xs text-gray-400 mb-2">Estado: ${order.status}</p>
                     <ul class="list-disc list-inside space-y-1">${itemsHtml}</ul>
                </div>
                <div class="mt-auto p-4 pt-0">
                    ${order.status === 'Listo' ? `<button data-id="${order.id}" data-order='${JSON.stringify(order)}' class="close-order-btn w-full bg-emerald-600 text-white px-3 py-1.5 rounded-md hover:bg-emerald-700 text-sm font-semibold">Cobrar, Imprimir y Cerrar</button>` : `<div class="text-center text-sm font-medium text-gray-400 pt-2">Pedido en preparación...</div>`}
                </div>`;
            return card;
        }

        function createHistoryOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card status-cerrado`;
            const itemsHtml = order.items.map(item => `<li class="text-sm text-gray-300">${item}</li>`).join('');
            const closedTime = order.closedAt ? new Date(order.closedAt.seconds * 1000).toLocaleString('es-CR') : 'N/A';
            card.innerHTML = `
                <div class="p-4">
                    <h3 class="text-lg font-bold text-white">Mesa ${order.tableNumber}</h3>
                    <p class="text-xs text-gray-400 mb-2">Cerrado el: ${closedTime}</p>
                    <ul class="list-disc list-inside space-y-1">${itemsHtml}</ul>
                </div>
                <div class="mt-auto p-4 pt-0 flex space-x-2">
                    <button data-order='${JSON.stringify(order)}' class="reprint-btn flex-1 bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded-md text-sm font-semibold">Re-imprimir</button>
                    <button data-id="${order.id}" class="delete-order-btn flex-1 bg-red-800 text-white px-3 py-1.5 rounded-md hover:bg-red-900 text-sm font-semibold">Borrar</button>
                </div>`;
            return card;
        }

        const handleCardClick = async (e) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/public/data/orders`;
            const target = e.target;
            
            if (target.classList.contains('update-status-btn')) {
                const { id, status } = target.dataset;
                await updateDoc(doc(db, collectionPath, id), { status });
            }
            if (target.classList.contains('close-order-btn')) {
                const { id, order } = target.dataset;
                const orderData = JSON.parse(order);
                printTicket(orderData.tableNumber, orderData.items);
                await updateDoc(doc(db, collectionPath, id), { status: "Cerrado", closedAt: serverTimestamp() });
            }
            if (target.classList.contains('reprint-btn')) {
                const { order } = target.dataset;
                const orderData = JSON.parse(order);
                printTicket(orderData.tableNumber, orderData.items);
            }
            if (target.classList.contains('delete-order-btn')) {
                const { id } = target.dataset;
                showConfirm("Borrar Pedido", "¿Estás seguro?", async () => {
                   await deleteDoc(doc(db, collectionPath, id));
                });
            }
        };
        
        kitchenOrdersContainer.addEventListener('click', handleCardClick);
        cashierOrdersContainer.addEventListener('click', handleCardClick);
        historyOrdersContainer.addEventListener('click', handleCardClick);

        deleteAllHistoryBtn.addEventListener('click', () => {
             showConfirm("Borrar TODO el Historial", "¿Estás seguro? Esta acción no se puede deshacer.", async () => {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionPath = `artifacts/${appId}/public/data/orders`;
                const q = query(collection(db, collectionPath), where("status", "==", "Cerrado"));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });
            });
        });

        // --- Menu Logic ---
        function listenToMenu() {
            if (!db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/public/data/menu`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                const menuItems = [];
                snapshot.forEach(doc => menuItems.push({ id: doc.id, ...doc.data() }));

                const groupedMenu = menuItems.reduce((acc, item) => {
                    const { category } = item;
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(item);
                    return acc;
                }, {});

                for (const category in groupedMenu) {
                    groupedMenu[category].sort((a, b) => a.name.localeCompare(b.name));
                }
                
                const sortedCategories = Object.keys(groupedMenu).sort();
                
                renderMenuForCashier(groupedMenu, sortedCategories);
                renderMenuForAdmin(groupedMenu, sortedCategories);
            }, (error) => {
                console.error("Error listening to menu:", error);
            });
        }

        function renderMenuForCashier(groupedMenu, categories) {
            const menuCategoriesContainer = document.getElementById('menu-categories');
            menuCategoriesContainer.innerHTML = '';
            
            if (categories.length === 0) {
                document.getElementById('menuItemsContainer').innerHTML = '<p class="text-gray-400 text-sm">Aún no hay platillos en el menú.</p>';
                return;
            }

            categories.forEach((category, index) => {
                const button = document.createElement('button');
                button.className = 'category-btn text-sm px-3 py-1 rounded-full transition-colors';
                button.textContent = category;
                button.dataset.category = category;
                
                if (index === 0) {
                    button.classList.add('bg-cyan-600', 'text-white');
                } else {
                    button.classList.add('bg-gray-700', 'text-cyan-200');
                }

                button.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(btn => {
                        btn.classList.remove('bg-cyan-600', 'text-white');
                        btn.classList.add('bg-gray-700', 'text-cyan-200');
                    });
                    button.classList.add('bg-cyan-600', 'text-white');
                    button.classList.remove('bg-gray-700', 'text-cyan-200');
                    renderMenuItems(groupedMenu[category]);
                });
                menuCategoriesContainer.appendChild(button);
            });

            renderMenuItems(groupedMenu[categories[0]]);
        }

        function renderMenuItems(items) {
            const menuItemsContainer = document.getElementById('menuItemsContainer');
            menuItemsContainer.innerHTML = '';
            items.forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'bg-cyan-800 hover:bg-cyan-700 text-cyan-200 text-sm px-3 py-1.5 rounded-full transition-colors';
                button.textContent = item.name;
                button.addEventListener('click', () => {
                    orderItemsTextarea.value += (orderItemsTextarea.value ? '\n' : '') + `1 ${item.name} - ₡${item.price}`;
                    orderItemsTextarea.focus();
                });
                menuItemsContainer.appendChild(button);
            });
        }

        function renderMenuForAdmin(groupedMenu, categories) {
            adminMenuList.innerHTML = '';
            if (categories.length === 0) {
                adminMenuList.innerHTML = '<p class="text-gray-400 text-sm text-center">Aún no hay platillos.</p>';
                return;
            }

            categories.forEach(category => {
                const categoryHeader = document.createElement('h4');
                categoryHeader.className = 'text-cyan-300 font-bold mt-3 border-b border-cyan-800 pb-1';
                categoryHeader.textContent = category;
                adminMenuList.appendChild(categoryHeader);

                groupedMenu[category].forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-800 p-2 rounded';
                    div.innerHTML = `
                        <span class="text-gray-300">${item.name} <span class="text-xs text-gray-400">(₡${item.price})</span></span>
                        <button data-id="${item.id}" class="delete-menu-item-btn text-red-400 hover:text-red-600 text-xs font-bold">BORRAR</button>
                    `;
                    adminMenuList.appendChild(div);
                });
            });
        }

        menuForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = menuItemNameInput.value.trim();
            const price = parseInt(menuItemPriceInput.value.trim(), 10);
            const category = menuItemCategorySelect.value;
            if (!name || isNaN(price) || !category) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/public/data/menu`;
            
            try {
                await addDoc(collection(db, collectionPath), { name, price, category });
                menuForm.reset();
            } catch (error) {
                console.error("Error adding menu item:", error);
            }
        });

        adminMenuList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-menu-item-btn')) {
                const id = e.target.dataset.id;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionPath = `artifacts/${appId}/public/data/menu`;

                showConfirm("Borrar Platillo", "¿Estás seguro?", async () => {
                    try {
                        await deleteDoc(doc(db, collectionPath, id));
                    } catch (error) {
                        console.error("Error deleting menu item:", error);
                    }
                });
            }
        });

        // --- Other Logic ---
        function printTicket(tableNumber, items) {
            const printArea = document.getElementById('print-area');
            const formattedDate = new Date().toLocaleString('es-CR', { timeZone: 'America/Costa_Rica' });
            const itemsHtml = items.map(item => `<li>${item}</li>`).join('');
            printArea.innerHTML = `
                <h1>Restaurante Regalo de Dios</h1>
                <p>Fecha: ${formattedDate}</p>
                <p>Mesa: ${tableNumber}</p>
                <ul>${itemsHtml}</ul>
                <p style="text-align: center;">¡Gracias por su visita!</p>`;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }

        function updateClock() {
            liveClockEl.textContent = new Date().toLocaleTimeString('es-CR', { timeZone: 'America/Costa_Rica' });
        }
        
        let countdownInterval;
        async function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            if (!db) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const configPath = `artifacts/${appId}/public/data/config`;
            const countdownDocRef = doc(db, configPath, 'countdown');
            
            try {
                const docSnap = await getDoc(countdownDocRef);
                let targetTimestamp;

                if (docSnap.exists()) {
                    targetTimestamp = docSnap.data().targetTimestamp;
                } else {
                    const defaultDate = new Date();
                    defaultDate.setFullYear(defaultDate.getFullYear() + 1);
                    targetTimestamp = defaultDate.getTime();
                    await setDoc(countdownDocRef, { targetTimestamp });
                }
                
                countdownInterval = setInterval(() => {
                    const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Costa_Rica' }));
                    const distance = targetTimestamp - now.getTime();
                    if (distance < 0) {
                        clearInterval(countdownInterval);
                        countdownTimerEl.innerHTML = "¡Finalizado!";
                        return;
                    }
                    const d = Math.floor(distance / 86400000), h = Math.floor((distance % 86400000) / 3600000), m = Math.floor((distance % 3600000) / 60000), s = Math.floor((distance % 60000) / 1000);
                    countdownTimerEl.innerHTML = `${d}d ${h}h ${m}m ${s}s`;
                }, 1000);

            } catch(error) {
                console.error("Error al cargar temporizador:", error);
                countdownTimerEl.textContent = "Error";
            }
        }
        
        async function updateCountdownAdmin(days, operation) {
            const daysToAdjust = parseInt(days);
            if (isNaN(daysToAdjust)) {
                adminFeedback.textContent = "Ingrese un número válido."; return;
            }
            if (!db) {
                adminFeedback.textContent = "Error: base de datos no conectada."; return;
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const configPath = `artifacts/${appId}/public/data/config`;
            const countdownDocRef = doc(db, configPath, 'countdown');

            try {
                 const docSnap = await getDoc(countdownDocRef);
                 if (!docSnap.exists()) {
                     await startCountdown(); 
                 }
                 
                 const currentTimestamp = (await getDoc(countdownDocRef)).data().targetTimestamp;
                 const currentDate = new Date(currentTimestamp);

                 if (operation === 'add') {
                    currentDate.setDate(currentDate.getDate() + daysToAdjust);
                 } else {
                    currentDate.setDate(currentDate.getDate() - daysToAdjust);
                 }

                 await setDoc(countdownDocRef, { targetTimestamp: currentDate.getTime() });

                 adminFeedback.textContent = "¡Fecha actualizada!";
                 adminDaysInput.value = '';
                 startCountdown(); 
                 setTimeout(() => adminFeedback.textContent = '', 3000);

            } catch (error) {
                console.error("Error actualizando temporizador:", error);
                adminFeedback.textContent = "Error al actualizar.";
            }
        }
        addDaysBtn.addEventListener('click', () => updateCountdownAdmin(adminDaysInput.value, 'add'));
        removeDaysBtn.addEventListener('click', () => updateCountdownAdmin(adminDaysInput.value, 'remove'));


        function showConfirm(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }
        confirmNoBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });
        confirmYesBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });
    </script>
</body>
</html>
