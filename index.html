<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurante Regalo de Dios - Sistema de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Montserrat:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Cargar la librería particles.js -->
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <style>
        /* --- TEMA: Noche Tropical Exclusiva --- */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #081C15; /* Verde muy oscuro */
            color: #FDF8E1; /* Blanco cálido */
        }
        
        /* Contenedor de Particles.js para el fondo */
        #particles-js {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            /* El fondo original se aplica aquí */
            background-image: url('https://images.unsplash.com/photo-1518173946687-a4c8892bbd9f?q=80&w=3000&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #081C15;
        }

        h1, h2, h3, h4 {
            font-family: 'Lora', serif;
            color: #FFC300; /* Dorado */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }

        .header-bg, .form-panel, .modal-panel {
            background-color: rgba(8, 28, 21, 0.8); /* Verde oscuro semi-transparente */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 195, 0, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border-radius: 1rem;
        }

        /* Asegurar que el contenido principal esté SOBRE el fondo de partículas */
        .container { 
            max-width: 1500px; 
            position: relative;
            z-index: 2;
        }
        
        /* Los modales ya tienen z-index alto (z-50), así que se mostrarán sobre todo */

        .order-card {
            transition: all 0.3s ease;
            border-radius: 0.75rem;
            background-color: rgba(27, 67, 50, 0.7); /* Verde medio */
            border: 1px solid rgba(255, 195, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .order-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
        }
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 25px rgba(255, 195, 0, 0.2);
            border-color: rgba(255, 195, 0, 0.3);
        }
        
        .status-en-espera::before { background-color: #ffeb3b; }
        .status-visto::before { background-color: #00bcd4; }
        .status-listo::before { background-color: #4caf50; }
        .status-cerrado::before { background-color: #5a5a5a; }

        .view-button {
            background-color: rgba(255, 195, 0, 0.1);
            color: #FFC300;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 195, 0, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .view-button.active {
            background-color: #FFC300;
            color: #081C15;
            box-shadow: 0 0 15px rgba(255, 195, 0, 0.6);
        }
        .view-button:hover:not(.active) {
            background-color: rgba(255, 195, 0, 0.2);
        }

        .primary-btn {
            background: linear-gradient(145deg, #ffc300, #ffae00);
            color: #1B4332; /* Verde oscuro para texto */
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .primary-btn:disabled {
            background: #5a5a5a;
            color: #aaa;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .form-panel input, .form-panel select, .form-panel textarea {
            background-color: rgba(8, 28, 21, 0.8);
            border: 1px solid rgba(255, 195, 0, 0.3);
            color: #FDF8E1;
        }
        ::placeholder { color: rgba(253, 248, 225, 0.4); }

        .golden-text {
            color: #FFC300;
            text-shadow: 1px 1px 8px rgba(255, 195, 0, 0.5);
        }

        .table-btn {
            background-color: rgba(27, 67, 50, 0.5);
            color: #FDF8E1;
            border: 1px solid rgba(255, 195, 0, 0.2);
            transition: all 0.2s ease;
        }
        .table-btn:hover:not(:disabled) {
            background-color: rgba(27, 67, 50, 1);
            border-color: rgba(255, 195, 0, 0.4);
        }
        .table-btn.selected {
            background-color: #FFC300;
            color: #1B4332;
            border-color: #FFC300;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 195, 0, 0.6);
        }
        .table-btn.occupied {
            background-color: rgba(120, 40, 40, 0.7);
            color: rgba(253, 248, 225, 0.5);
            border-color: rgba(217, 83, 79, 0.4);
            cursor: not-allowed;
        }

        /* --- Estilos del Calendario Exclusivo --- */
        #calendarView .form-panel {
            background-color: rgba(8, 28, 21, 0.95);
        }
        #calendar-grid {
            grid-template-rows: auto repeat(6, 1fr);
            border-top: 1px solid rgba(255, 195, 0, 0.2);
            border-left: 1px solid rgba(255, 195, 0, 0.2);
        }
        .calendar-day-header {
            color: #FFC300;
            opacity: 0.8;
            font-weight: 600;
            padding: 0.75rem 0;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255, 195, 0, 0.2);
            border-right: 1px solid rgba(255, 195, 0, 0.2);
        }
        .calendar-day {
            min-height: 8rem;
            border-right: 1px solid rgba(255, 195, 0, 0.2);
            border-bottom: 1px solid rgba(255, 195, 0, 0.2);
            transition: all 0.2s ease-in-out;
            background-color: rgba(27, 67, 50, 0.4);
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
        }
        .calendar-day:hover:not(.other-month) {
            background-color: rgba(27, 67, 50, 0.8);
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .calendar-day-number {
            font-size: 1.1rem;
            font-weight: 600;
            color: #FDF8E1;
        }
        .calendar-day.today {
            border: 2px solid #FFC300;
            background-color: rgba(255, 195, 0, 0.1);
        }
        .calendar-day.other-month {
            background-color: transparent;
            opacity: 0.4;
            pointer-events: none;
        }
        .event-details {
            font-size: 0.75rem;
            background-color: rgba(255, 195, 0, 0.8);
            color: #1B4332;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: auto;
        }
        
        /* --- Estilos de la Calculadora Exclusiva --- */
        #calculatorView .form-panel {
            background-color: rgba(8, 28, 21, 0.9);
        }

        #calc-display {
            background-color: rgba(8, 28, 21, 1);
            border: 1px solid rgba(255, 195, 0, 0.3);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
            font-family: 'Orbitron', sans-serif;
            color: #FDF8E1;
            padding: 1.5rem 1rem;
            font-size: 2.5rem;
        }

        .calc-btn {
            border-radius: 9999px;
            aspect-ratio: 1 / 1;
            font-weight: bold;
            transition: all 0.1s ease-in;
            border: 1px solid transparent;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calc-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 195, 0, 0.3);
        }

        .calc-btn.number {
            background-color: rgba(27, 67, 50, 0.7);
            color: #FDF8E1;
            border-color: rgba(255, 195, 0, 0.2);
        }
        .calc-btn.number:hover {
            background-color: rgba(27, 67, 50, 1);
        }

        .calc-btn.operator {
            background-color: rgba(255, 195, 0, 0.2);
            color: #FFC300;
        }
        .calc-btn.operator:hover {
            background-color: rgba(255, 195, 0, 0.4);
        }

        .calc-btn.special {
            background-color: rgba(217, 83, 79, 0.3);
            color: #D9534F;
        }
        .calc-btn.special:hover {
            background-color: rgba(217, 83, 79, 0.5);
        }
        
        .calc-btn.equal {
            background: linear-gradient(145deg, #ffc300, #ffae00);
            color: #1B4332;
        }


        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: 'Courier New', monospace; font-size: 9pt; color: #000;
            }
            #print-area h1 { font-size: 12pt; text-align: center; }
            #print-area p { margin: 2px 0; }
            #print-area ul { list-style-type: none; padding: 5px 0; margin: 5px 0; border-top: 1px dashed #000; border-bottom: 1px dashed #000; }
        }
    </style>
</head>
<body>
    
    <!-- Elemento para Particles.js -->
    <div id="particles-js"></div>
    
    <!-- Banner de Notificación en Página -->
    <div id="notification-banner" class="hidden fixed top-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-lg z-[100] transform translate-x-full transition-transform duration-300">
        <p class="font-bold text-lg">¡Pedido Listo!</p>
        <p id="notification-message"></p>
    </div>

    <!-- Pantalla de Contraseña -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div id="password-box" class="modal-panel p-8 rounded-lg text-center w-full max-w-sm relative overflow-hidden">
             <div class="relative z-10">
                <img src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/imagen_2025-10-30_080250936.png" alt="Logo Regalo de Dios" class="mx-auto h-24 w-24 object-contain rounded-full shadow-md mb-6">
                <h2 class="text-2xl font-bold mb-4 text-white">Ingresar Contraseña</h2>
                <p id="greeting-message" class="text-lg text-gray-300 mb-6 font-light"></p>
                <form id="password-form">
                    <input type="password" id="password-input" class="w-full p-3 rounded-md text-center bg-gray-700 text-white" placeholder="********">
                    <p id="error-message" class="text-red-400 text-sm mt-2 hidden">Contraseña incorrecta.</p>
                    <button type="submit" class="w-full primary-btn py-3 rounded-md text-lg font-semibold mt-6">Acceder</button>
                </form>
                <p class="login-watermark mt-4">CREADO POR FABIAN CARVAJAL</p>
            </div>
        </div>
    </div>

    <!-- Panel de Administrador -->
    <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="modal-panel p-8 rounded-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-white text-center">Panel de Administrador</h2>
            <div class="space-y-6">
                <!-- Days -->
                <div class="space-y-2">
                    <label for="admin-days-input" class="block text-sm font-medium text-blue-200">Ajustar Días:</label>
                    <div class="flex space-x-2">
                        <input type="number" id="admin-days-input" class="w-full p-2 rounded-md bg-gray-700 text-white" placeholder="Ej: 1">
                        <button id="add-days-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-semibold">+</button>
                        <button id="remove-days-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md font-semibold">-</button>
                    </div>
                </div>
                <!-- Hours -->
                <div class="space-y-2">
                    <label for="admin-hours-input" class="block text-sm font-medium text-blue-200">Ajustar Horas:</label>
                    <div class="flex space-x-2">
                        <input type="number" id="admin-hours-input" class="w-full p-2 rounded-md bg-gray-700 text-white" placeholder="Ej: 12">
                        <button id="add-hours-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-semibold">+</button>
                        <button id="remove-hours-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md font-semibold">-</button>
                    </div>
                </div>
                <!-- Minutes -->
                 <div class="space-y-2">
                    <label for="admin-minutes-input" class="block text-sm font-medium text-blue-200">Ajustar Minutos:</label>
                    <div class="flex space-x-2">
                        <input type="number" id="admin-minutes-input" class="w-full p-2 rounded-md bg-gray-700 text-white" placeholder="Ej: 30">
                        <button id="add-minutes-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-semibold">+</button>
                        <button id="remove-minutes-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md font-semibold">-</button>
                    </div>
                </div>
                <p id="admin-feedback" class="text-green-400 text-sm pt-2 h-6 text-center"></p>
            </div>
            <button id="admin-logout-btn" class="w-full bg-gray-700 text-cyan-400 hover:bg-gray-600 py-2 mt-8 rounded-md font-semibold border border-cyan-400">Volver</button>
        </div>
    </div>
    
    <!-- Panel de Administrador de Menú -->
    <div id="menu-admin-panel" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="modal-panel p-8 rounded-lg w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6 text-white text-center">Administrar Menú</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Columna para Añadir -->
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-cyan-400">Añadir Platillo</h3>
                    <form id="add-menu-item-form" class="space-y-4">
                        <div>
                            <label for="menu-item-name" class="block text-sm font-medium text-blue-200">Nombre</label>
                            <input type="text" id="menu-item-name" class="w-full p-2 rounded-md bg-gray-700 text-white" required>
                        </div>
                        <div>
                            <label for="menu-item-price" class="block text-sm font-medium text-blue-200">Precio (₡)</label>
                            <input type="number" id="menu-item-price" class="w-full p-2 rounded-md bg-gray-700 text-white" required>
                        </div>
                        <div>
                            <label for="menu-item-category" class="block text-sm font-medium text-blue-200">Categoría</label>
                            <select id="menu-item-category" class="w-full p-2 rounded-md bg-gray-700 text-white" required>
                                <option value="Desayunos">Desayunos</option>
                                <option value="Antojitos">Antojitos</option>
                                <option value="Combos">Combos</option>
                                <option value="Casados">Casados</option>
                                <option value="Platos Fuertes">Platos Fuertes</option>
                                <option value="Hamburguesas">Hamburguesas</option>
                                <option value="Gallos">Gallos</option>
                                <option value="Menú Niños">Menú Niños</option>
                                <option value="Bebidas">Bebidas</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full primary-btn py-2 rounded-md font-semibold">Añadir Platillo</button>
                    </form>
                </div>
                <!-- Columna para Ver/Eliminar -->
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-cyan-400">Menú Actual</h3>
                    <div id="current-menu-list" class="h-64 overflow-y-auto space-y-2 p-2 bg-gray-900 rounded-md">
                        <!-- Lista se genera con JS -->
                    </div>
                </div>
            </div>
            <button id="menu-admin-logout-btn" class="w-full bg-gray-700 text-cyan-400 hover:bg-gray-600 py-2 mt-8 rounded-md font-semibold border border-cyan-400">Volver</button>
        </div>
    </div>

    <!-- Modal de Confirmación Genérico -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="modal-panel p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <h2 id="confirm-title" class="text-2xl font-bold mb-4 text-white">Confirmar Acción</h2>
            <p id="confirm-message" class="text-gray-300 mb-6">¿Estás seguro?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-btn" class="px-8 py-2 bg-red-800 hover:bg-red-900 rounded-md font-semibold">Sí</button>
                <button id="confirm-no-btn" class="px-8 py-2 bg-gray-600 hover:bg-gray-700 rounded-md font-semibold">No</button>
            </div>
        </div>
    </div>

    <!-- Modal de Cerrar Sesión / Cerrar Día -->
    <div id="logout-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="modal-panel p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-white">¿Qué deseas hacer?</h2>
            <p id="logout-info" class="text-gray-300 mb-6">Puedes cerrar tu sesión temporalmente o realizar el cierre de caja del día.</p>
            <div class="space-y-4">
                <button id="close-day-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-md font-semibold">Cerrar Día y Imprimir Reporte</button>
                <button id="just-logout-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-md font-semibold">Cerrar Sesión por ahora</button>
                <button id="cancel-logout-btn" class="w-full text-cyan-400 hover:text-white py-2 mt-4 rounded-md">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Cobro -->
    <div id="payment-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="modal-panel p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold mb-6 text-center text-cyan-400">Realizar Cobro</h2>
            <div class="space-y-4 text-lg">
                <div class="flex justify-between items-center">
                    <span class="text-gray-300">Total a Pagar:</span>
                    <span id="payment-total" class="font-bold text-yellow-400">₡0</span>
                </div>
                <div class="flex justify-between items-center">
                    <label for="payment-paid" class="text-gray-300">Paga con:</label>
                    <input type="number" id="payment-paid" class="w-1/2 p-2 rounded-md bg-gray-700 text-white text-right" placeholder="0">
                </div>
                <div class="flex justify-between items-center text-xl">
                    <span class="text-gray-300">Vuelto:</span>
                    <span id="payment-change" class="font-bold text-green-400">₡0</span>
                </div>
            </div>
            <div class="flex justify-center space-x-4 mt-8">
                <button id="finalize-payment-btn" class="flex-1 primary-btn py-3 rounded-md font-semibold" disabled>Finalizar, Imprimir y Cerrar</button>
                <button id="cancel-payment-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 rounded-md font-semibold">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Cita del Calendario -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="modal-panel p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 id="event-modal-title" class="text-3xl font-bold mb-6 text-center text-cyan-400">Añadir Cita</h2>
            <form id="event-form">
                <input type="hidden" id="event-date">
                <textarea id="event-text" class="w-full p-3 text-white bg-gray-700 rounded-md" rows="3" placeholder="Descripción de la cita..." required></textarea>
                <div class="flex justify-center space-x-4 mt-6">
                    <button type="submit" class="flex-1 primary-btn py-2 rounded-md font-semibold">Guardar</button>
                    <button id="cancel-event-btn" type="button" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-md font-semibold">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Edición de Pedido -->
    <div id="edit-order-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="modal-panel p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 id="edit-order-modal-title" class="text-3xl font-bold mb-6 text-center text-cyan-400">Editar Pedido</h2>
            <form id="edit-order-form">
                <input type="hidden" id="edit-order-id">
                <textarea id="edit-order-items" class="w-full p-3 text-white bg-gray-700 rounded-md" rows="8" required></textarea>
                <div class="flex justify-center space-x-4 mt-6">
                    <button type="submit" class="flex-1 primary-btn py-2 rounded-md font-semibold">Guardar Cambios</button>
                    <button id="cancel-edit-order-btn" type="button" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-md font-semibold">Cancelar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Contenido Principal de la Aplicación -->
    <div class="container mx-auto p-4 hidden">
        <header class="header-bg rounded-lg p-6 mb-8 text-center relative">
            <div class="absolute top-4 left-4 text-left">
                <p class="text-xs font-semibold text-cyan-400">Tiempo restante:</p>
                <p id="countdown-timer" class="text-lg font-bold text-yellow-400">Cargando...</p>
            </div>
            <button id="logoutBtn" class="absolute top-4 right-4 bg-gray-700 text-cyan-400 hover:bg-gray-600 px-4 py-1.5 rounded-full text-sm font-semibold border border-cyan-400">Cerrar Sesión</button>
            <p id="live-clock" class="absolute top-12 right-4 text-xs font-semibold text-cyan-400"></p>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <img src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/imagen_2025-10-30_080250936.png" alt="Logo Regalo de Dios" class="h-16 w-16 object-contain rounded-full shadow-md">
                <h1 class="text-4xl font-bold leading-tight golden-text">Restaurante Regalo de Dios</h1>
            </div>
            <div class="flex flex-wrap justify-center items-center mt-6 gap-3">
                <button id="showCashierViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Vista Caja</button>
                <button id="showKitchenViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Vista Cocina</button>
                <button id="showHistoryViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Historial</button>
                <button id="showReportsViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Reportes</button>
                <button id="showCalculatorViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Calculadora</button>
                <button id="showCalendarViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Calendario</button>
            </div>
             <div id="auth-status" class="text-center mt-4 text-sm text-gray-400">Conectando a Firebase...</div>
        </header>

        <!-- Vista Caja -->
        <div id="cashierView">
             <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="lg:col-span-2 lg:sticky lg:top-8">
                    <div class="form-panel p-8 rounded-lg">
                        <h2 class="text-3xl font-bold mb-6 text-center text-cyan-400">Crear Nuevo Pedido</h2>
                        <form id="orderForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-blue-200 mb-1">Seleccionar Mesa</label>
                                <div id="table-selection-grid" class="grid grid-cols-5 gap-2 mt-2"></div>
                            </div>
                            <div>
                                <label for="orderItems" class="block text-sm font-medium text-blue-200 mb-1">Artículos del Pedido</label>
                                <textarea id="orderItems" rows="5" required class="w-full p-3 text-white bg-gray-700 rounded-md" placeholder="Ej:\n1 Hamburguesa\n1 Papas fritas"></textarea>
                            </div>
                             <div class="mt-4">
                                <h4 class="text-lg font-bold text-cyan-300 mb-2">Menú Rápido</h4>
                                 <div id="menu-categories" class="flex flex-wrap gap-2 border-b border-cyan-800 pb-2 mb-2">
                                    <!-- Category buttons will be injected here -->
                                </div>
                                <div id="menuItemsContainer" class="flex flex-wrap gap-2 max-h-48 overflow-y-auto">
                                    <!-- Menu items will be injected here -->
                                </div>
                            </div>
                            <div class="flex space-x-2 mt-6">
                                <button id="send-to-kitchen-btn" type="button" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white py-3 rounded-md font-semibold">Enviar a Cocina</button>
                                <button id="print-and-send-btn" type="button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-md font-semibold">Imprimir y Enviar</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-3">
                     <div class="form-panel p-8 rounded-lg">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-3xl font-bold text-cyan-400">Estado de Mesas Activas</h3>
                            <button id="deleteAllActiveOrdersBtn" class="bg-red-800 text-white p-2 rounded-full hover:bg-red-900 transition-colors" title="Borrar todos los pedidos activos">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        <div id="cashierOrders" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Cocina -->
        <div id="kitchenView" class="hidden">
            <h2 class="text-3xl font-bold mb-6 text-center text-cyan-400">Pedidos Activos en Cocina</h2>
            <div id="kitchenOrders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>

        <!-- Vista Historial -->
        <div id="historyView" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-cyan-400">Historial de Pedidos</h2>
                <button id="deleteAllHistoryBtn" class="bg-red-800 text-white px-4 py-2 rounded-md hover:bg-red-900 text-sm font-semibold">Borrar todo el historial</button>
            </div>
            <div id="historyOrders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>

        <!-- Vista Reportes -->
        <div id="reportsView" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 form-panel p-8 rounded-lg">
                    <h2 id="report-date-display" class="text-3xl font-bold mb-6 text-center text-cyan-400">Reporte del Día</h2>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-2xl font-bold text-cyan-300 mb-4">Ventas Totales</h3>
                            <p id="total-sales" class="text-4xl font-bold text-yellow-400">₡0</p>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-cyan-300 mb-4">Resumen de Platillos Vendidos</h3>
                            <div id="top-items-list" class="space-y-2 max-h-96 overflow-y-auto pr-4">
                               <p class="text-gray-400">No hay datos para mostrar.</p>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="form-panel p-8 rounded-lg">
                    <h3 class="text-2xl font-bold text-cyan-300 mb-4">Cierres de Día Guardados</h3>
                    <div id="past-reports-list" class="space-y-2 max-h-[calc(100vh-20rem)] overflow-y-auto">
                        <p class="text-gray-400">No hay reportes guardados.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vista Calculadora -->
        <div id="calculatorView" class="hidden">
             <div class="form-panel p-8 rounded-lg max-w-sm mx-auto relative overflow-hidden">
                 <img src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/imagen_2025-10-30_080250936.png" class="absolute inset-0 w-full h-full object-contain opacity-10 pointer-events-none" alt="Watermark Logo">
                 <div class="relative z-10">
                    <h2 class="text-3xl font-bold mb-6 text-center text-cyan-400">Calculadora</h2>
                    <div id="calc-display" class="bg-gray-800 text-white text-4xl text-right p-4 rounded-md mb-4 overflow-x-auto">0</div>
                    <div class="grid grid-cols-4 gap-2">
                        <button class="calc-btn special">C</button>
                        <button class="calc-btn operator">/</button>
                        <button class="calc-btn operator">*</button>
                        <button class="calc-btn operator">-</button>
                        <button class="calc-btn number">7</button>
                        <button class="calc-btn number">8</button>
                        <button class="calc-btn number">9</button>
                        <button class="calc-btn operator row-span-2">+</button>
                        <button class="calc-btn number">4</button>
                        <button class="calc-btn number">5</button>
                        <button class="calc-btn number">6</button>
                        <button class="calc-btn number">1</button>
                        <button class="calc-btn number">2</button>
                        <button class="calc-btn number">3</button>
                        <button class="calc-btn equal row-span-2">=</button>
                        <button class="calc-btn number col-span-2">0</button>
                        <button class="calc-btn number">.</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Calendario -->
        <div id="calendarView" class="hidden">
             <div class="form-panel p-8 rounded-lg">
                <div class="flex justify-between items-center mb-6">
                    <button id="prev-month-btn" class="primary-btn px-4 py-2 rounded-md">&lt;</button>
                    <h2 id="calendar-header" class="text-3xl font-bold text-center text-cyan-400"></h2>
                    <button id="next-month-btn" class="primary-btn px-4 py-2 rounded-md">&gt;</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7"></div>
            </div>
        </div>
    </div>
    
    <!-- Área de Impresión (oculta) -->
    <div id="print-area" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs, serverTimestamp, setLogLevel, getDoc, setDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Selectores de Elementos del DOM ---
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');
        const mainContainer = document.querySelector('.container');
        const logoutBtn = document.getElementById('logoutBtn');
        const liveClockEl = document.getElementById('live-clock');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const authStatusEl = document.getElementById('auth-status');
        
        const cashierView = document.getElementById('cashierView');
        const kitchenView = document.getElementById('kitchenView');
        const historyView = document.getElementById('historyView');
        const reportsView = document.getElementById('reportsView');
        const calculatorView = document.getElementById('calculatorView');
        const calendarView = document.getElementById('calendarView');

        const showCashierViewBtn = document.getElementById('showCashierViewBtn');
        const showKitchenViewBtn = document.getElementById('showKitchenViewBtn');
        const showHistoryViewBtn = document.getElementById('showHistoryViewBtn');
        const showReportsViewBtn = document.getElementById('showReportsViewBtn');
        const showCalculatorViewBtn = document.getElementById('showCalculatorViewBtn');
        const showCalendarViewBtn = document.getElementById('showCalendarViewBtn');

        const orderForm = document.getElementById('orderForm');
        const tableSelectionGrid = document.getElementById('table-selection-grid');
        const orderItemsTextarea = document.getElementById('orderItems');
        const kitchenOrdersContainer = document.getElementById('kitchenOrders');
        const cashierOrdersContainer = document.getElementById('cashierOrders');
        const historyOrdersContainer = document.getElementById('historyOrders');
        const deleteAllHistoryBtn = document.getElementById('deleteAllHistoryBtn');
        const deleteAllActiveOrdersBtn = document.getElementById('deleteAllActiveOrdersBtn');
        
        const adminPanel = document.getElementById('admin-panel');
        const adminDaysInput = document.getElementById('admin-days-input');
        const addDaysBtn = document.getElementById('add-days-btn');
        const removeDaysBtn = document.getElementById('remove-days-btn');
        const adminHoursInput = document.getElementById('admin-hours-input');
        const addHoursBtn = document.getElementById('add-hours-btn');
        const removeHoursBtn = document.getElementById('remove-hours-btn');
        const adminMinutesInput = document.getElementById('admin-minutes-input');
        const addMinutesBtn = document.getElementById('add-minutes-btn');
        const removeMinutesBtn = document.getElementById('remove-minutes-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminFeedback = document.getElementById('admin-feedback');
        
        const menuAdminPanel = document.getElementById('menu-admin-panel');
        const addMenuItemForm = document.getElementById('add-menu-item-form');
        const menuItemName = document.getElementById('menu-item-name');
        const menuItemPrice = document.getElementById('menu-item-price');
        const menuItemCategory = document.getElementById('menu-item-category');
        const currentMenuList = document.getElementById('current-menu-list');
        const menuAdminLogoutBtn = document.getElementById('menu-admin-logout-btn');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let confirmCallback = null;
        
        const logoutConfirmModal = document.getElementById('logout-confirm-modal');
        const closeDayBtn = document.getElementById('close-day-btn');
        const justLogoutBtn = document.getElementById('just-logout-btn');
        const cancelLogoutBtn = document.getElementById('cancel-logout-btn');

        const menuItemsContainer = document.getElementById('menuItemsContainer');
        
        const paymentModal = document.getElementById('payment-modal');
        const paymentTotalEl = document.getElementById('payment-total');
        const paymentPaidInput = document.getElementById('payment-paid');
        const paymentChangeEl = document.getElementById('payment-change');
        const finalizePaymentBtn = document.getElementById('finalize-payment-btn');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        let currentOrderForPayment = null;

        const reportDateDisplay = document.getElementById('report-date-display');
        const totalSalesEl = document.getElementById('total-sales');
        const topItemsListEl = document.getElementById('top-items-list');
        const pastReportsListEl = document.getElementById('past-reports-list');
        
        const calcDisplay = document.getElementById('calc-display');
        const calcBtns = document.querySelectorAll('.calc-btn');
        
        const calendarHeader = document.getElementById('calendar-header');
        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');

        const eventModal = document.getElementById('event-modal');
        const eventModalTitle = document.getElementById('event-modal-title');
        const eventForm = document.getElementById('event-form');
        const eventDateInput = document.getElementById('event-date');
        const eventTextInput = document.getElementById('event-text');
        const cancelEventBtn = document.getElementById('cancel-event-btn');

        const editOrderModal = document.getElementById('edit-order-modal');
        const editOrderModalTitle = document.getElementById('edit-order-modal-title');
        const editOrderForm = document.getElementById('edit-order-form');
        const editOrderIdInput = document.getElementById('edit-order-id');
        const editOrderItemsTextarea = document.getElementById('edit-order-items');
        const cancelEditOrderBtn = document.getElementById('cancel-edit-order-btn');


        let db, auth;
        let previousOrders = []; 
        let selectedTable = null;
        
        const firebaseConfig = {
            apiKey: "AIzaSyC7OIars9qrTeZo3-tFxqCeGwTA5CmZeng",
            authDomain: "posdeventaregalodedios.firebaseapp.com",
            projectId: "posdeventaregalodedios",
            storageBucket: "posdeventaregalodedios.appspot.com",
            messagingSenderId: "883274283691",
            appId: "1:883274283691:web:ed88029e2faf58245c55ee",
            measurementId: "G-WD5KPNQRPC"
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- Saludo Dinámico ---
            function updateGreeting() {
                const greetingEl = document.getElementById('greeting-message');
                if (!greetingEl) return;
                
                const hour = new Date().getHours();
                let greetingText = '';

                if (hour < 12) {
                    greetingText = 'Buenos días';
                } else if (hour < 18) {
                    greetingText = 'Buenas tardes';
                } else {
                    greetingText = 'Buenas noches';
                }
                
                greetingEl.textContent = greetingText;
            }
            updateGreeting();
            // --- Fin Saludo Dinámico ---
            
            // --- Cargar Particles.js ---
            if (typeof particlesJS !== 'undefined') {
                particlesJS('particles-js', {
                  "particles": {
                    "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
                    "color": { "value": "#FFC300" }, // Dorado
                    "shape": { "type": "circle" },
                    "opacity": { "value": 0.5, "random": true, "anim": { "enable": true, "speed": 1, "opacity_min": 0.1, "sync": false } },
                    "size": { "value": 3, "random": true, "anim": { "enable": false } },
                    "line_linked": {
                      "enable": true,
                      "distance": 150,
                      "color": "#FFC300", // Dorado
                      "opacity": 0.3,
                      "width": 1
                    },
                    "move": {
                      "enable": true,
                      "speed": 2,
                      "direction": "none",
                      "random": true,
                      "straight": false,
                      "out_mode": "out",
                      "bounce": false
                    }
                  },
                  "interactivity": {
                    "detect_on": "canvas",
                    "events": {
                      "onhover": { "enable": true, "mode": "grab" },
                      "onclick": { "enable": true, "mode": "push" },
                      "resize": true
                    },
                    "modes": {
                      "grab": { "distance": 140, "line_opacity": 0.8 },
                      "push": { "particles_nb": 4 }
                    }
                  },
                  "retina_detect": true
                });
            }
            // --- Fin Particles.js ---
        });
        
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            if (password === '1010') {
                passwordModal.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                initializeFirebase();
            } else if (password === '8873') {
                passwordModal.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                 if (!db) initializeFirebase();
            } else if (password === '0000') { 
                passwordModal.classList.add('hidden');
                menuAdminPanel.classList.remove('hidden');
                 if (!db) initializeFirebase();
            }
            else {
                errorMessage.classList.remove('hidden');
                passwordInput.value = '';
            }
        });
        passwordInput.addEventListener('input', () => errorMessage.classList.add('hidden'));
        
        logoutBtn.addEventListener('click', () => logoutConfirmModal.classList.remove('hidden'));
        cancelLogoutBtn.addEventListener('click', () => logoutConfirmModal.classList.add('hidden'));
        justLogoutBtn.addEventListener('click', () => location.reload());
        closeDayBtn.addEventListener('click', handleCloseDay);

        adminLogoutBtn.addEventListener('click', () => {
            adminPanel.classList.add('hidden');
            passwordModal.classList.remove('hidden');
        });
        
        menuAdminLogoutBtn.addEventListener('click', () => {
            menuAdminPanel.classList.add('hidden');
            passwordModal.classList.remove('hidden');
        });

        async function initializeFirebase() {
            if (db) return; 
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        authStatusEl.textContent = `Conectado a tu Firebase`;
                        authStatusEl.style.color = '#4ade80';
                        if (!mainContainer.classList.contains('hidden') || !adminPanel.classList.contains('hidden') || !menuAdminPanel.classList.contains('hidden')) {
                           await seedMenuData();
                           initializeApplication();
                        }
                    } else {
                        authStatusEl.textContent = "Autenticando...";
                        authStatusEl.style.color = '#ffeb3b';
                    }
                });
                
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                authStatusEl.style.color = '#ef4444';
                if (error.code === 'auth/configuration-not-found') {
                    const authUrl = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication/providers`;
                    authStatusEl.innerHTML = `<b>Error:</b> Habilita "Authentication" y el proveedor "Anónimo". <a href="${authUrl}" target="_blank" class="text-cyan-400 underline">Clic aquí para ir a la configuración.</a>`;
                } else {
                    authStatusEl.textContent = "Error de conexión con tu Firebase.";
                }
            }
        }

        function initializeApplication() {
            initializeTableSelection();
            switchView('cashier');
            updateClock();
            setInterval(updateClock, 1000);
            listenToConfigChanges();
            listenToOrders();
            listenToMenu();
            listenToDailyReports();
            initializeCalculator();
            initializeCalendar();
            requestNotificationPermission();
            
            if (addMenuItemForm) {
                addMenuItemForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = menuItemName.value;
                    const price = parseInt(menuItemPrice.value);
                    const category = menuItemCategory.value;
                    if (name && price > 0 && category) {
                        try {
                            await addDoc(collection(db, 'menu'), { name, price, category });
                            menuItemName.value = '';
                            menuItemPrice.value = '';
                            menuItemCategory.value = 'Desayunos'; // Reset to default
                        } catch (error) {
                            console.error("Error adding item:", error);
                            alert("Error al añadir platillo.");
                        }
                    }
                });
            }

            if(currentMenuList) {
                currentMenuList.addEventListener('click', async (e) => {
                    const deleteBtn = e.target.closest('.delete-menu-item-btn');
                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        showConfirm("Eliminar Platillo", "¿Estás seguro que quieres eliminar este platillo?", async () => {
                            try {
                                await deleteDoc(doc(db, 'menu', id));
                            } catch (error) {
                                console.error("Error deleting item: ", error);
                                alert("Error al eliminar platillo.");
                            }
                        });
                    }
                });
            }
        }

        function initializeTableSelection() {
            tableSelectionGrid.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'table-btn';
                button.textContent = i;
                button.dataset.tableNumber = i;
                tableSelectionGrid.appendChild(button);
            }

            tableSelectionGrid.addEventListener('click', (e) => {
                const target = e.target.closest('.table-btn');
                if (target && !target.disabled) {
                    document.querySelectorAll('.table-btn').forEach(btn => btn.classList.remove('selected'));
                    target.classList.add('selected');
                    selectedTable = parseInt(target.dataset.tableNumber);
                }
            });
        }
        
        function switchView(view) {
            [cashierView, kitchenView, historyView, reportsView, calculatorView, calendarView].forEach(v => v.classList.add('hidden'));
            [showCashierViewBtn, showKitchenViewBtn, showHistoryViewBtn, showReportsViewBtn, showCalculatorViewBtn, showCalendarViewBtn].forEach(b => b.classList.remove('active'));
            
            if (view === 'cashier') {
                cashierView.classList.remove('hidden');
                showCashierViewBtn.classList.add('active');
            } else if (view === 'kitchen') {
                kitchenView.classList.remove('hidden');
                showKitchenViewBtn.classList.add('active');
            } else if (view === 'history') {
                historyView.classList.remove('hidden');
                showHistoryViewBtn.classList.add('active');
            } else if (view === 'reports') {
                reportsView.classList.remove('hidden');
                showReportsViewBtn.classList.add('active');
                generateCurrentDayReport(previousOrders); // Usar la lista de pedidos ya cargada
            } else if (view === 'calculator') {
                calculatorView.classList.remove('hidden');
                showCalculatorViewBtn.classList.add('active');
            } else if (view === 'calendar') {
                calendarView.classList.remove('hidden');
                showCalendarViewBtn.classList.add('active');
            }
        }
        showCashierViewBtn.addEventListener('click', () => switchView('cashier'));
        showKitchenViewBtn.addEventListener('click', () => switchView('kitchen'));
        showHistoryViewBtn.addEventListener('click', () => switchView('history'));
        showReportsViewBtn.addEventListener('click', () => switchView('reports'));
        showCalculatorViewBtn.addEventListener('click', () => switchView('calculator'));
        showCalendarViewBtn.addEventListener('click', () => switchView('calendar'));
        
        const sendToKitchenBtn = document.getElementById('send-to-kitchen-btn');
        const printAndSendBtn = document.getElementById('print-and-send-btn');
        
        sendToKitchenBtn.addEventListener('click', () => submitOrder(false));
        printAndSendBtn.addEventListener('click', () => submitOrder(true));

        async function submitOrder(print = false) {
            const items = orderItemsTextarea.value.trim().split('\n').filter(Boolean);
            if (!selectedTable) {
                alert("Por favor, seleccione una mesa.");
                return;
            }
            if (items.length === 0) {
                 alert("Por favor, añada artículos al pedido.");
                return;
            }
            
            sendToKitchenBtn.disabled = true;
            printAndSendBtn.disabled = true;
            sendToKitchenBtn.textContent = 'Enviando...';
            printAndSendBtn.textContent = 'Enviando...';

            if(print) {
                const tempOrder = { tableNumber: selectedTable, items };
                printKitchenTicket(tempOrder);
            }

            try {
                await addDoc(collection(db, 'orders'), {
                    tableNumber: selectedTable,
                    items,
                    status: 'En espera',
                    createdAt: serverTimestamp(),
                    closedAt: null
                });
                orderItemsTextarea.value = '';
                selectedTable = null;
                document.querySelectorAll('.table-btn').forEach(btn => btn.classList.remove('selected'));
            } catch (error) {
                console.error("Error al añadir pedido:", error);
            } finally {
                sendToKitchenBtn.disabled = false;
                printAndSendBtn.disabled = false;
                sendToKitchenBtn.textContent = 'Enviar a Cocina';
                printAndSendBtn.textContent = 'Imprimir y Enviar';
            }
        }

        function listenToOrders() {
            const q = query(collection(db, 'orders'));

            onSnapshot(q, (snapshot) => {
                let currentOrders = [];
                snapshot.forEach(doc => currentOrders.push({ id: doc.id, ...doc.data() }));
                
                checkForReadyOrders(previousOrders, currentOrders);
                previousOrders = currentOrders;

                renderAllOrders(currentOrders);

                // ACTUALIZAR REPORTE EN VIVO: Si la vista de reportes está activa, regenerar el reporte.
                if (!reportsView.classList.contains('hidden')) {
                    generateCurrentDayReport(currentOrders); 
                }
            }, (error) => {
                console.error("Error al escuchar pedidos:", error);
            });
        }
        
        function renderAllOrders(orders) {
            kitchenOrdersContainer.innerHTML = '';
            cashierOrdersContainer.innerHTML = '';
            historyOrdersContainer.innerHTML = '';

            const activeOrders = orders.filter(o => o.status !== 'Cerrado');
            const closedOrders = orders.filter(o => o.status === 'Cerrado');
            
            const occupiedTables = new Set(activeOrders.map(o => o.tableNumber));
            document.querySelectorAll('.table-btn').forEach(btn => {
                const tableNum = parseInt(btn.dataset.tableNumber);
                if(occupiedTables.has(tableNum)) {
                    btn.classList.add('occupied');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('occupied');
                    btn.disabled = false;
                }
            });


            if (activeOrders.length > 0) {
                 activeOrders.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); 
                activeOrders.forEach(order => {
                    kitchenOrdersContainer.appendChild(createOrderCard(order));
                    cashierOrdersContainer.appendChild(createCashierOrderCard(order));
                });
            } else {
                const noOrdersMsg = '<p class="text-center col-span-full text-gray-400 p-4">No hay pedidos activos.</p>';
                kitchenOrdersContainer.innerHTML = noOrdersMsg;
                cashierOrdersContainer.innerHTML = noOrdersMsg;
            }

            if (closedOrders.length > 0) {
                deleteAllHistoryBtn.classList.remove('hidden');
                closedOrders.sort((a, b) => (b.closedAt?.seconds || 0) - (a.closedAt?.seconds || 0));
                closedOrders.forEach(order => historyOrdersContainer.appendChild(createHistoryOrderCard(order)));
            } else {
                deleteAllHistoryBtn.classList.add('hidden');
                historyOrdersContainer.innerHTML = '<p class="text-center col-span-full text-gray-400 p-4">No hay pedidos en el historial.</p>';
            }
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card flex flex-col justify-between status-${order.status.toLowerCase().replace(' ', '-')}`;
            const statusColors = { "En espera": "bg-yellow-400 text-yellow-900", "Visto": "bg-cyan-500 text-cyan-900", "Listo": "bg-emerald-500 text-emerald-900" };
            const statusIcons = { "En espera": "status-icon-en-espera", "Visto": "status-icon-visto", "Listo": "status-icon-listo" };
            const itemsHtml = order.items.map(item => `<li class="text-gray-200">${item}</li>`).join('');
            const time = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString('es-CR') : '...';

            card.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-white">Mesa ${order.tableNumber}</h3>
                        <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${statusColors[order.status]}">
                           <span class="status-icon ${statusIcons[order.status]}"></span>${order.status}
                        </span>
                    </div>
                    <ul class="list-disc list-inside space-y-1 mb-4">${itemsHtml}</ul>
                    <p class="text-xs text-gray-400">${time}</p>
                </div>
                <div class="flex space-x-2 p-4 pt-0">
                    ${order.status === 'En espera' ? `<button data-id="${order.id}" data-status="Visto" class="update-status-btn flex-1 bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded-md text-sm font-semibold">Marcar Visto</button>` : ''}
                    ${order.status === 'Visto' ? `<button data-id="${order.id}" data-status="Listo" class="update-status-btn flex-1 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-md font-semibold">Marcar Listo</button>` : ''}
                </div>`;
            return card;
        }

        function createCashierOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card flex flex-col justify-between status-${order.status.toLowerCase().replace(' ', '-')}`;
            const itemsHtml = order.items.map(item => `<li class="text-sm text-gray-300">${item}</li>`).join('');
            const total = calculateTotal(order.items);

            card.innerHTML = `
                <div class="p-4">
                     <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">Mesa ${order.tableNumber}</h3>
                        <button data-id="${order.id}" data-order='${JSON.stringify(order)}' class="edit-order-btn text-cyan-300 hover:text-white p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                              <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                     </div>
                     <p class="text-xs text-gray-400 mb-2">Estado: ${order.status}</p>
                     <ul class="list-disc list-inside space-y-1 pb-4">${itemsHtml}</ul>
                </div>
                <div class="mt-auto p-4 pt-0">
                     <div class="text-right font-bold text-yellow-400 text-lg mb-2">
                        Total: ₡${total.toLocaleString('es-CR')}
                    </div>
                    ${order.status === 'Listo' ? `<button data-id="${order.id}" data-order='${JSON.stringify(order)}' class="close-order-btn w-full bg-emerald-600 text-white px-3 py-1.5 rounded-md hover:bg-emerald-700 text-sm font-semibold">Cobrar, Imprimir y Cerrar</button>` : `<div class="text-center text-sm font-medium text-gray-400 pt-2">Pedido en preparación...</div>`}
                </div>`;
            return card;
        }

        function createHistoryOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card status-cerrado`;
            const itemsHtml = order.items.map(item => `<li class="text-sm text-gray-300">${item}</li>`).join('');
            const closedTime = order.closedAt ? new Date(order.closedAt.seconds * 1000).toLocaleString('es-CR') : 'N/A';
            card.innerHTML = `
                <div class="p-4">
                    <h3 class="text-lg font-bold text-white">Mesa ${order.tableNumber}</h3>
                    <p class="text-xs text-gray-400 mb-2">Cerrado el: ${closedTime}</p>
                    <ul class="list-disc list-inside space-y-1">${itemsHtml}</ul>
                </div>
                <div class="mt-auto p-4 pt-0 flex space-x-2">
                    <button data-order='${JSON.stringify(order)}' class="reprint-btn flex-1 bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded-md text-sm font-semibold">Re-imprimir</button>
                    <button data-id="${order.id}" class="delete-order-btn flex-1 bg-red-800 text-white px-3 py-1.5 rounded-md hover:bg-red-900 text-sm font-semibold">Borrar</button>
                </div>`;
            return card;
        }

        const handleCardClick = async (e) => {
            const target = e.target;
            const collectionPath = "orders";
            
            const updateBtn = target.closest('.update-status-btn');
            if (updateBtn) {
                const { id, status } = updateBtn.dataset;
                await updateDoc(doc(db, collectionPath, id), { status });
                return;
            }

            const closeBtn = target.closest('.close-order-btn');
            if (closeBtn) {
                const orderData = JSON.parse(closeBtn.dataset.order);
                showPaymentModal(orderData);
                return;
            }
            
            const reprintBtn = target.closest('.reprint-btn');
            if (reprintBtn) {
                const { order } = reprintBtn.dataset;
                const orderData = JSON.parse(order);
                printTicket(orderData.tableNumber, orderData.items, orderData.total);
                return;
            }
            
            const deleteBtn = target.closest('.delete-order-btn');
            if (deleteBtn) {
                const { id } = deleteBtn.dataset;
                showConfirm("Borrar Pedido", "¿Estás seguro?", async () => {
                   await deleteDoc(doc(db, collectionPath, id));
                });
                return;
            }

            const editBtn = target.closest('.edit-order-btn');
            if (editBtn) {
                const orderData = JSON.parse(editBtn.dataset.order);
                showEditOrderModal(orderData);
                return;
            }
        };
        
        kitchenOrdersContainer.addEventListener('click', handleCardClick);
        cashierOrdersContainer.addEventListener('click', handleCardClick);
        historyOrdersContainer.addEventListener('click', handleCardClick);

        deleteAllHistoryBtn.addEventListener('click', () => {
             showConfirm("Borrar TODO el Historial", "¿Estás seguro? Esta acción no se puede deshacer.", async () => {
                const q = query(collection(db, "orders"), where("status", "==", "Cerrado"));
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
            });
        });

        deleteAllActiveOrdersBtn.addEventListener('click', () => {
            showConfirm("Borrar Pedidos Activos", "¿Estás seguro de que quieres borrar TODOS los pedidos activos? Esta acción no se puede deshacer.", async () => {
                const q = query(collection(db, "orders"), where("status", "!=", "Cerrado"));
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
            });
        });


        // --- Menu Logic ---
        function listenToMenu() {
            if (!db) return;
            const collectionPath = `menu`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                const menuItems = [];
                snapshot.forEach(doc => menuItems.push({ id: doc.id, ...doc.data() }));

                const groupedMenu = menuItems.reduce((acc, item) => {
                    const { category } = item;
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(item);
                    return acc;
                }, {});

                for (const category in groupedMenu) {
                    groupedMenu[category].sort((a, b) => a.name.localeCompare(b.name));
                }
                
                const sortedCategories = Object.keys(groupedMenu).sort();
                
                renderMenuForCashier(groupedMenu, sortedCategories);
                renderMenuForAdmin(groupedMenu, sortedCategories); 
            }, (error) => {
                console.error("Error listening to menu:", error);
            });
        }

        function renderMenuForCashier(groupedMenu, categories) {
            const menuCategoriesContainer = document.getElementById('menu-categories');
            if (!menuCategoriesContainer) return;
            menuCategoriesContainer.innerHTML = '';
            
            if (categories.length === 0) {
                if(document.getElementById('menuItemsContainer')) {
                    document.getElementById('menuItemsContainer').innerHTML = '<p class="text-gray-400 text-sm">Cargando menú...</p>';
                }
                return;
            }

            categories.forEach((category, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'category-btn text-sm px-3 py-1 rounded-full transition-colors';
                button.textContent = category;
                button.dataset.category = category;
                
                if (index === 0) {
                    button.classList.add('bg-cyan-600', 'text-white');
                } else {
                    button.classList.add('bg-gray-700', 'text-cyan-200');
                }

                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.category-btn').forEach(btn => {
                        btn.classList.remove('bg-cyan-600', 'text-white');
                        btn.classList.add('bg-gray-700', 'text-cyan-200');
                    });
                    button.classList.add('bg-cyan-600', 'text-white');
                    button.classList.remove('bg-gray-700', 'text-cyan-200');
                    renderMenuItems(groupedMenu[category]);
                });
                menuCategoriesContainer.appendChild(button);
            });

            if (categories.length > 0) {
               renderMenuItems(groupedMenu[categories[0]]);
            }
        }

        function renderMenuItems(items) {
            const menuItemsContainer = document.getElementById('menuItemsContainer');
            if (!menuItemsContainer) return;
            menuItemsContainer.innerHTML = '';
            items.forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'bg-cyan-800 hover:bg-cyan-700 text-cyan-200 text-sm px-3 py-1.5 rounded-full transition-colors';
                button.textContent = item.name;
                button.addEventListener('click', () => {
                    orderItemsTextarea.value += (orderItemsTextarea.value ? '\n' : '') + `1 ${item.name} - ₡${item.price}`;
                    orderItemsTextarea.focus();
                });
                menuItemsContainer.appendChild(button);
            });
        }
        
        function renderMenuForAdmin(groupedMenu, categories) {
            if (!currentMenuList) return;
            currentMenuList.innerHTML = '';
            if (categories.length === 0) {
                currentMenuList.innerHTML = '<p class="text-gray-400 text-sm p-4">No hay platillos en el menú.</p>';
                return;
            }

            categories.forEach(category => {
                const categoryTitle = document.createElement('h4');
                categoryTitle.className = 'text-lg font-semibold text-cyan-400 sticky top-0 bg-gray-900 px-2 py-1';
                categoryTitle.textContent = category;
                currentMenuList.appendChild(categoryTitle);

                const itemsList = document.createElement('ul');
                itemsList.className = 'mb-4';
                
                groupedMenu[category].forEach(item => {
                    const itemEl = document.createElement('li');
                    itemEl.className = 'flex justify-between items-center text-sm text-gray-300 p-2 hover:bg-gray-800 rounded-md';
                    itemEl.innerHTML = `
                        <span>${item.name} - ₡${item.price}</span>
                        <button type="button" data-id="${item.id}" class="delete-menu-item-btn text-red-500 hover:text-red-400 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="pointer-events: none;">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    `;
                    itemsList.appendChild(itemEl);
                });
                currentMenuList.appendChild(itemsList);
            });
        }
        
        // --- Payment Modal Logic ---
        function calculateTotal(items) {
            return items.reduce((total, item) => {
                const priceMatch = item.match(/₡(\d+)/);
                if (priceMatch && priceMatch[1]) {
                    const quantityMatch = item.match(/^(\d+)\s/);
                    const quantity = quantityMatch ? parseInt(quantityMatch[1], 10) : 1;
                    return total + (parseInt(priceMatch[1], 10) * quantity);
                }
                return total;
            }, 0);
        }

        function showPaymentModal(order) {
            currentOrderForPayment = order;
            const total = calculateTotal(order.items);
            paymentTotalEl.textContent = `₡${total.toLocaleString('es-CR')}`;
            paymentPaidInput.value = '';
            paymentChangeEl.textContent = '₡0';
            finalizePaymentBtn.disabled = true;
            paymentModal.classList.remove('hidden');
            paymentPaidInput.focus();
        }

        paymentPaidInput.addEventListener('input', () => {
            const total = calculateTotal(currentOrderForPayment.items);
            const paid = parseInt(paymentPaidInput.value, 10) || 0;
            const change = paid - total;
            
            if (change >= 0) {
                paymentChangeEl.textContent = `₡${change.toLocaleString('es-CR')}`;
                finalizePaymentBtn.disabled = false;
            } else {
                paymentChangeEl.textContent = '₡0';
                finalizePaymentBtn.disabled = true;
            }
        });

        cancelPaymentBtn.addEventListener('click', () => {
            paymentModal.classList.add('hidden');
            currentOrderForPayment = null;
        });

        finalizePaymentBtn.addEventListener('click', async () => {
            const total = calculateTotal(currentOrderForPayment.items);
            const paid = parseInt(paymentPaidInput.value, 10);
            const change = paid - total;
            
            printTicket(currentOrderForPayment.tableNumber, currentOrderForPayment.items, total, paid, change);
            
            const collectionPath = "orders";
            await updateDoc(doc(db, collectionPath, currentOrderForPayment.id), { 
                status: "Cerrado", 
                closedAt: serverTimestamp(),
                total: total
            });
            
            paymentModal.classList.add('hidden');
            currentOrderForPayment = null;
        });
        
        // --- Edit Order Modal ---
        function showEditOrderModal(order) {
            editOrderIdInput.value = order.id;
            editOrderModalTitle.textContent = `Editar Pedido - Mesa ${order.tableNumber}`;
            editOrderItemsTextarea.value = order.items.join('\n');
            editOrderModal.classList.remove('hidden');
        }
        
        cancelEditOrderBtn.addEventListener('click', () => {
            editOrderModal.classList.add('hidden');
        });

        editOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const orderId = editOrderIdInput.value;
            const updatedItems = editOrderItemsTextarea.value.trim().split('\n').filter(Boolean);

            if (updatedItems.length > 0) {
                try {
                    await updateDoc(doc(db, "orders", orderId), {
                        items: updatedItems
                    });
                    editOrderModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error updating order:", error);
                    alert("No se pudo actualizar el pedido.");
                }
            } else {
                alert("El pedido no puede estar vacío.");
            }
        });


        // --- Other Logic ---
        function printTicket(tableNumber, items, total, paid, change) {
            const printArea = document.getElementById('print-area');
            const formattedDate = new Date().toLocaleString('es-CR', { timeZone: 'America/Costa_Rica' });
            const itemsHtml = items.map(item => `<li>${item}</li>`).join('');
            
            let paymentHtml = '';
            if (total !== undefined && paid !== undefined && change !== undefined) {
                 paymentHtml = `
                    <p>----------------------------------------</p>
                    <p><strong>Total: ₡${total.toLocaleString('es-CR')}</strong></p>
                    <p>Paga con: ₡${paid.toLocaleString('es-CR')}</p>
                    <p>Vuelto: ₡${change.toLocaleString('es-CR')}</p>
                 `;
            } else if (total !== undefined) {
                 paymentHtml = `
                    <p>----------------------------------------</p>
                    <p><strong>Total: ₡${total.toLocaleString('es-CR')}</strong></p>
                 `;
            }

            printArea.innerHTML = `
                <div style="text-align: center; margin-bottom: 10px;">
                    <img src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/imagen_2025-10-30_080250936.png" alt="Logo" style="width: 80px; margin: 0 auto;"/>
                </div>
                <h1 style="margin-bottom: 5px;">Restaurante Regalo de Dios</h1>
                <p style="text-align: center;">Tel: +506 6010 6552</p>
                <p>----------------------------------------</p>
                <p>Fecha: ${formattedDate}</p>
                <p>Mesa: ${tableNumber}</p>
                <ul>${itemsHtml}</ul>
                ${paymentHtml}
                <p style="text-align: center; margin-top: 10px;">¡Gracias por su visita!</p>`;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }
        
        function printKitchenTicket(order) {
            const printArea = document.getElementById('print-area');
            const formattedDate = new Date().toLocaleString('es-CR', { timeZone: 'America/Costa_Rica' });
            const itemsHtml = order.items.map(item => `<li>${item}</li>`).join('');

            printArea.innerHTML = `
                <h1 style="font-size: 16pt;">COMANDA - Mesa ${order.tableNumber}</h1>
                <p>Hora: ${formattedDate}</p>
                <ul style="font-size: 11pt;">${itemsHtml}</ul>
            `;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }
        
        function printDailyReport(totalSales, itemCounts, orderCount) {
             const printArea = document.getElementById('print-area');
            const formattedDate = new Date().toLocaleString('es-CR', { timeZone: 'America/Costa_Rica' });
            const topItemsHtml = Object.entries(itemCounts).sort(([,a],[,b]) => b-a).map(([name, count]) => `<li>${count}x - ${name}</li>`).join('');

            printArea.innerHTML = `
                <div style="text-align: center; margin-bottom: 10px;">
                    <img src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/imagen_2025-10-30_080250936.png" alt="Logo" style="width: 80px; margin: 0 auto;"/>
                </div>
                <h1>CIERRE DE CAJA (CORTE Z)</h1>
                <p style="text-align: center;">Restaurante Regalo de Dios</p>
                <p style="text-align: center;">Tel: +506 6010 6552</p>
                <p>----------------------------------------</p>
                <p>Fecha de Cierre: ${formattedDate}</p>
                <p>----------------------------------------</p>
                <p><strong>Venta Total del Día: ₡${totalSales.toLocaleString('es-CR')}</strong></p>
                <p>Pedidos Totales: ${orderCount}</p>
                <p>----------------------------------------</p>
                <h3>Platillos Vendidos:</h3>
                <ul>${topItemsHtml}</ul>
            `;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }

        async function handleCloseDay() {
            logoutConfirmModal.classList.add('hidden');

            const qOrders = query(collection(db, "orders"));
            const orderSnapshot = await getDocs(qOrders);
            const allOrders = orderSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

            const activeOrders = allOrders.filter(order => order.status !== 'Cerrado');

            if (activeOrders.length > 0) {
                const activeTables = activeOrders.map(o => o.tableNumber).join(', ');
                const errorMessage = `No se puede cerrar el día. Las siguientes mesas tienen pedidos activos: Mesa ${activeTables}. Por favor, ciérralos desde la Vista Caja.`;
                showConfirm("Error", errorMessage, () => {});
                confirmYesBtn.classList.add('hidden');
                confirmNoBtn.textContent = 'Entendido';
                confirmNoBtn.onclick = () => {
                    confirmModal.classList.add('hidden');
                    confirmYesBtn.classList.remove('hidden');
                    confirmNoBtn.textContent = 'No';
                };
                return;
            }
            
            const closedDocs = orderSnapshot.docs.filter(doc => doc.data().status === 'Cerrado');
            
            if(closedDocs.length === 0) {
                showConfirm("Cierre de Día", "No hay ventas facturadas para cerrar.", () => location.reload());
                 confirmYesBtn.classList.add('hidden');
                 confirmNoBtn.textContent = 'OK';
                 confirmNoBtn.onclick = () => location.reload();
                return;
            }

            let totalSales = 0;
            const itemCounts = {};
            
            closedDocs.forEach(doc => {
                const order = doc.data();
                totalSales += order.total || 0;
                order.items.forEach(itemString => {
                    const itemName = itemString.replace(/^\d+\s/, '').replace(/\s-\s₡\d+$/, '').trim();
                    itemCounts[itemName] = (itemCounts[itemName] || 0) + 1;
                });
            });

            printDailyReport(totalSales, itemCounts, closedDocs.length);

            const reportDate = new Date();
            const reportId = `${reportDate.getFullYear()}-${String(reportDate.getMonth() + 1).padStart(2, '0')}-${String(reportDate.getDate()).padStart(2, '0')}`;
            const reportData = {
                date: serverTimestamp(),
                totalSales,
                itemCounts,
                orderCount: closedDocs.length
            };
            await setDoc(doc(db, "daily_reports", reportId), reportData);

            const deletePromises = closedDocs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deletePromises);
            
            showConfirm("¡Éxito!", "El día ha sido cerrado y el reporte se ha impreso y guardado.", () => location.reload());
            confirmYesBtn.classList.add('hidden');
            confirmNoBtn.textContent = 'OK';
            confirmNoBtn.onclick = () => location.reload();
        }


        function updateClock() {
            liveClockEl.textContent = new Date().toLocaleTimeString('es-CR', { timeZone: 'America/Costa_Rica' });
        }
        
        let countdownInterval;
        function listenToConfigChanges() {
            if (!db) return;
            const countdownDocRef = doc(db, "config", 'countdown');
            onSnapshot(countdownDocRef, async (docSnap) => {
                let targetTimestamp;
                if (docSnap.exists()) {
                    targetTimestamp = docSnap.data().targetTimestamp;
                } else {
                    const defaultDate = new Date();
                    defaultDate.setFullYear(defaultDate.getFullYear() + 1);
                    targetTimestamp = defaultDate.getTime();
                    await setDoc(doc(db, "config", "countdown"), { targetTimestamp });
                }

                if (countdownInterval) clearInterval(countdownInterval);
                
                countdownInterval = setInterval(() => {
                    const now = new Date();
                    const distance = targetTimestamp - now.getTime();
                    if (distance < 0) {
                        clearInterval(countdownInterval);
                        countdownTimerEl.innerHTML = "¡Finalizado!";
                        return;
                    }
                    const d = Math.floor(distance / 86400000), h = Math.floor((distance % 86400000) / 3600000), m = Math.floor((distance % 3600000) / 60000), s = Math.floor((distance % 60000) / 1000);
                    countdownTimerEl.innerHTML = `${d}d ${h}h ${m}m ${s}s`;
                }, 1000);
            }, (error) => {
                 console.error("Error listening to config changes:", error);
                 countdownTimerEl.textContent = "Error";
            });
        }
        
        async function updateCountdownAdmin(value, unit, operation) {
            const amount = parseInt(value);
            if (isNaN(amount) || amount < 0) {
                adminFeedback.textContent = "Ingrese un número válido."; return;
            }
            if (!db) {
                adminFeedback.textContent = "Error: base de datos no conectada."; return;
            }
            
            const countdownDocRef = doc(db, "config", 'countdown');

            try {
                 const docSnap = await getDoc(countdownDocRef);
                 let currentTimestamp;
                 if (docSnap.exists()) {
                    currentTimestamp = docSnap.data().targetTimestamp;
                 } else { 
                    const defaultDate = new Date();
                    defaultDate.setFullYear(defaultDate.getFullYear() + 1);
                    currentTimestamp = defaultDate.getTime();
                 }
                 
                 const sign = operation === 'add' ? 1 : -1;
                 let newTimestamp = currentTimestamp;

                 if (unit === 'days') {
                    newTimestamp += amount * sign * 24 * 60 * 60 * 1000;
                 } else if (unit === 'hours') {
                    newTimestamp += amount * sign * 60 * 60 * 1000;
                 } else if (unit === 'minutes') {
                    newTimestamp += amount * sign * 60 * 1000;
                 }

                 await setDoc(countdownDocRef, { targetTimestamp: newTimestamp });

                 adminFeedback.textContent = "¡Fecha actualizada!";
                 document.getElementById(`admin-${unit}-input`).value = '';
                 setTimeout(() => adminFeedback.textContent = '', 3000);

            } catch (error) {
                console.error("Error actualizando temporizador:", error);
                adminFeedback.textContent = "Error al actualizar.";
            }
        }
        addDaysBtn.addEventListener('click', () => updateCountdownAdmin(document.getElementById('admin-days-input').value, 'days', 'add'));
        removeDaysBtn.addEventListener('click', () => updateCountdownAdmin(document.getElementById('admin-days-input').value, 'days', 'remove'));
        addHoursBtn.addEventListener('click', () => updateCountdownAdmin(document.getElementById('admin-hours-input').value, 'hours', 'add'));
        removeHoursBtn.addEventListener('click', () => updateCountdownAdmin(document.getElementById('admin-hours-input').value, 'hours', 'remove'));
        addMinutesBtn.addEventListener('click', () => updateCountdownAdmin(document.getElementById('admin-minutes-input').value, 'minutes', 'add'));
        removeMinutesBtn.addEventListener('click', () => updateCountdownAdmin(document.getElementById('admin-minutes-input').value, 'minutes', 'remove'));


        // --- Reports Logic ---

        function displayReportData(title, data) {
            reportDateDisplay.textContent = title;
            totalSalesEl.textContent = `₡${(data.totalSales || 0).toLocaleString('es-CR')}`;
            
            const sortedItems = Object.entries(data.itemCounts || {}).sort(([, a], [, b]) => b - a);

            topItemsListEl.innerHTML = '';
            if (sortedItems.length === 0) {
                topItemsListEl.innerHTML = '<p class="text-gray-400">No hay datos para mostrar.</p>';
            } else {
                sortedItems.forEach(([name, count]) => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center text-gray-300";
                    div.innerHTML = `<span>${name}</span> <span class="font-bold text-cyan-400">${count}</span>`;
                    topItemsListEl.appendChild(div);
                });
            }
        }

        async function generateCurrentDayReport(allOrders) {
            if (!db) return;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let totalSales = 0;
            const itemCounts = {};
            
            // Usar la lista de pedidos (allOrders) pasada como argumento en lugar de leer de la BD de nuevo
            const closedTodayOrders = allOrders.filter(order => 
                order.status === "Cerrado" && 
                order.closedAt && 
                order.closedAt.toDate() >= today
            );

            closedTodayOrders.forEach(order => {
                totalSales += order.total || 0;
                order.items.forEach(itemString => {
                    const itemName = itemString.replace(/^\d+\s/, '').replace(/\s-\s₡\d+$/, '').trim();
                    itemCounts[itemName] = (itemCounts[itemName] || 0) + 1;
                });
            });

            displayReportData('Reporte de Hoy (En Vivo)', { totalSales, itemCounts });
        }
        
        function listenToDailyReports() {
             if (!db) return;
            const q = query(collection(db, "daily_reports"));

            onSnapshot(q, (snapshot) => {
                const reports = [];
                snapshot.forEach(doc => reports.push({ id: doc.id, ...doc.data() }));
                reports.sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0)); 
                
                pastReportsListEl.innerHTML = '';
                if(reports.length === 0) {
                    pastReportsListEl.innerHTML = '<p class="text-gray-400">No hay reportes guardados.</p>';
                    return;
                }

                reports.forEach(report => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-2 rounded-md hover:bg-cyan-800 transition-colors view-button';
                    button.textContent = report.id;
                    button.onclick = () => {
                         displayReportData(`Reporte de ${report.id}`, report);
                    };
                    pastReportsListEl.appendChild(button);
                });
            });
        }

        function showConfirm(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
             // Reset buttons
            confirmYesBtn.classList.remove('hidden');
            confirmNoBtn.textContent = 'No';
            confirmNoBtn.onclick = () => {
                confirmModal.classList.add('hidden');
                confirmCallback = null;
            };
        }
        confirmNoBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });
        confirmYesBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });
        
        async function seedMenuData() {
            if (!db) return;
            const menuConfigDoc = doc(db, 'config', 'menu_seeded');
            try {
                const docSnap = await getDoc(menuConfigDoc);

                if (!docSnap.exists()) {
                    console.log("Menu collection is empty. Seeding data...");
                    const menuCollection = collection(db, 'menu');
                    const menuData = [
                        { name: 'Típicos', price: 3500, category: 'Desayunos' },{ name: 'Desayuno Campesino', price: 3500, category: 'Desayunos' },{ name: 'Desayuno Delux', price: 4000, category: 'Desayunos' },{ name: 'Omelette (jamón, queso y espinaca)', price: 3200, category: 'Desayunos' },{ name: 'Tostadas Francesas', price: 3000, category: 'Desayunos' },{ name: 'Pancakes', price: 3000, category: 'Desayunos' },{ name: 'Fajitas (Pollo/Res)', price: 4000, category: 'Antojitos' },{ name: 'Quesadilla (Pollo/Carne)', price: 3700, category: 'Antojitos' },{ name: 'Quesadilla de Camarón', price: 4300, category: 'Antojitos' },{ name: 'Taco Tico de Carne', price: 3000, category: 'Antojitos' },{ name: 'Taco de la Casa (Mixto)', price: 5000, category: 'Antojitos' },{ name: 'Nachos (Carne/Pollo)', price: 3500, category: 'Antojitos' },{ name: 'Nachos Mixtos', price: 5000, category: 'Antojitos' },{ name: 'Papas Supremas (Pollo/Carne)', price: 3500, category: 'Antojitos' },{ name: 'Pollo Frito', price: 2500, category: 'Antojitos' },{ name: 'Bigorón', price: 3000, category: 'Antojitos' },{ name: 'Surtidas', price: 13500, category: 'Antojitos' },{ name: 'Sándwich de Carne', price: 3000, category: 'Antojitos' },{ name: 'Taco Grande con Papas', price: 3000, category: 'Antojitos' },{ name: 'Taco Pequeño con Papas', price: 2000, category: 'Antojitos' },{ name: 'Aliñadas', price: 3000, category: 'Antojitos' },{ name: 'Chorreadas', price: 4500, category: 'Antojitos' },{ name: 'Empanada Sencilla', price: 2000, category: 'Antojitos' },{ name: 'Empanada Arreglada', price: 2600, category: 'Antojitos' },{ name: 'Aros de Cebolla', price: 2000, category: 'Antojitos' },{ name: 'Chifrijo', price: 5000, category: 'Antojitos' },{ name: 'Nuggets de Pollo', price: 3500, category: 'Antojitos' },{ name: 'Dados de Pescado', price: 3500, category: 'Antojitos' },{ name: 'Patacones Arreglados', price: 3500, category: 'Antojitos' },{ name: 'Papas del Campo', price: 2000, category: 'Antojitos' },{ name: 'Papas Fritas', price: 1500, category: 'Antojitos' },{ name: 'Chicharrones', price: 4500, category: 'Antojitos' },{ name: 'Costilla a la BBQ', price: 7000, category: 'Antojitos' },{ name: 'Alitas de Pollo (6 pz)', price: 4500, category: 'Antojitos' },{ name: 'Alitas de Pollo (12 pz)', price: 8100, category: 'Antojitos' },{ name: 'Surtida Lux', price: 15000, category: 'Antojitos' },{ name: 'Parrillada Mixta', price: 9000, category: 'Antojitos' },{ name: 'Choripán', price: 5300, category: 'Antojitos' },{ name: 'Combo 1 (Hamb. Peq, Taco Peq, Papas)', price: 5000, category: 'Combos' },{ name: 'Combo 2 (Hot Dog, Taco, Papas)', price: 5000, category: 'Combos' },{ name: 'Casado Pechuga Pollo', price: 4000, category: 'Casados' },{ name: 'Casado Pescado', price: 4000, category: 'Casados' },{ name: 'Casado Chuleta', price: 4000, category: 'Casados' },{ name: 'Casado Carne en Salsa', price: 4000, category: 'Casados' },{ name: 'Casado Bistec', price: 4000, category: 'Casados' },{ name: 'Casado Pollo en Salsa', price: 4000, category: 'Casados' },{ name: 'Pechuga Pollo Parmesana', price: 5000, category: 'Platos Fuertes' },{ name: 'Pechuga Pollo a la Plancha', price: 5000, category: 'Platos Fuertes' },{ name: 'Arroz de la Casa', price: 5000, category: 'Platos Fuertes' },{ name: 'Arroz con Camarones', price: 5000, category: 'Platos Fuertes' },{ name: 'Churrasco', price: 7000, category: 'Platos Fuertes' },{ name: 'Costilla de Cerdo BBQ', price: 7000, category: 'Platos Fuertes' },{ name: 'Filete de Pescado', price: 5000, category: 'Platos Fuertes' },{ name: 'Pasta Alfredo', price: 5000, category: 'Platos Fuertes' },{ name: 'Pasta Boloñesa', price: 5000, category: 'Platos Fuertes' },{ name: 'Spaghetti con Camarones', price: 5000, category: 'Platos Fuertes' },{ name: 'Hamb. Pollo Pequeña', price: 2500, category: 'Hamburguesas' },{ name: 'Hamb. Pollo Grande', price: 5000, category: 'Hamburguesas' },{ name: 'Hamb. Torta de Carne Pequeña', price: 2500, category: 'Hamburguesas' },{ name: 'Hamb. Torta de Carne Grande', price: 5000, category: 'Hamburguesas' },{ name: 'Hamb. Carne Desmechada Pequeña', price: 2500, category: 'Hamburguesas' },{ name: 'Hamb. Carne Desmechada Grande', price: 5000, category: 'Hamburguesas' },{ name: 'Gallo de Papa', price: 1500, category: 'Gallos' },{ name: 'Gallo de Pollo', price: 1500, category: 'Gallos' },{ name: 'Gallo de Carne', price: 1500, category: 'Gallos' },{ name: 'Gallo de Salchichón', price: 1500, category: 'Gallos' },{ name: 'Gallo de Torta de Huevo', price: 1500, category: 'Gallos' },{ name: 'Gallo de Carne en Salsa', price: 1500, category: 'Gallos' },{ name: 'Gallo de Chorizo', price: 1500, category: 'Gallos' },{ name: 'Gallo de Pescado', price: 1500, category: 'Gallos' },{ name: 'Nuggets (Niños)', price: 3000, category: 'Menú Niños' },{ name: 'Mini Hamburguesa', price: 2000, category: 'Menú Niños' },{ name: 'Mini Quesadilla', price: 2000, category: 'Menú Niños' },{ name: 'Mini Sándwich', price: 2500, category: 'Menú Niños' },{ name: 'Batido en Agua', price: 1500, category: 'Bebidas' },{ name: 'Batido en Leche', price: 2000, category: 'Bebidas' },{ name: 'Pepsi 600 ml', price: 1000, category: 'Bebidas' },{ name: 'Tropical', price: 1000, category: 'Bebidas' },{ name: 'Pepsi 2.5 L', price: 1700, category: 'Bebidas' },{ name: 'Tropical 2.5 L', price: 1700, category: 'Bebidas' },{ name: 'Capuchino', price: 2500, category: 'Bebidas' },{ name: 'Café', price: 1000, category: 'Bebidas' },{ name: 'Café con Leche', price: 1500, category: 'Bebidas' },{ name: 'Chocolate', price: 1500, category: 'Bebidas' },{ name: 'Agua Dulce', price: 1000, category: 'Bebidas' },{ name: 'Leche', price: 1200, category: 'Bebidas' }
                    ];
                    
                    const addPromises = menuData.map(item => addDoc(menuCollection, item));
                    await Promise.all(addPromises);
                    await setDoc(menuConfigDoc, { seeded: true });
                    console.log("Menu data seeded successfully.");
                }
            } catch (error) {
                console.error("Error seeding menu data:", error);
            }
        }
        
        // --- Calculator Logic ---
        function initializeCalculator() {
            let currentValue = '0';
            let operator = null;
            let previousValue = null;
            let resetDisplay = false;

            calcBtns.forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.textContent;

                    if (!isNaN(value) || value === '.') {
                        if (resetDisplay) {
                            currentValue = value;
                            resetDisplay = false;
                        } else {
                            currentValue = currentValue === '0' && value !== '.' ? value : currentValue + value;
                        }
                    } else if (['+', '-', '*', '/'].includes(value)) {
                        if (operator && previousValue) {
                           currentValue = String(eval(`${previousValue} ${operator} ${currentValue}`));
                        }
                        operator = value;
                        previousValue = currentValue;
                        resetDisplay = true;
                    } else if (value === '=') {
                        if (operator && previousValue) {
                            currentValue = String(eval(`${previousValue} ${operator} ${currentValue}`));
                            operator = null;
                            previousValue = null;
                            resetDisplay = true;
                        }
                    } else if (value === 'C') {
                        currentValue = '0';
                        operator = null;
                        previousValue = null;
                        resetDisplay = false;
                    }
                    
                    calcDisplay.textContent = currentValue;
                });
            });
        }

        // --- Calendar Logic ---
        function initializeCalendar() {
            let currentDate = new Date(2025, 0, 1);
            let events = {};

            function renderCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                calendarHeader.textContent = `${new Date(year, month).toLocaleString('es-CR', { month: 'long', year: 'numeric' })}`;
                calendarGrid.innerHTML = '';
                
                const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                daysOfWeek.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day-header';
                    dayEl.textContent = day;
                    calendarGrid.appendChild(dayEl);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'calendar-day other-month';
                    calendarGrid.appendChild(emptyCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    const dateId = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    dayCell.className = 'calendar-day';
                    dayCell.dataset.date = dateId;

                    if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                        dayCell.classList.add('today');
                    }
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'calendar-day-number';
                    dayNumber.textContent = day;
                    dayCell.appendChild(dayNumber);
                    
                    const eventsContainer = document.createElement('div');
                    dayCell.appendChild(eventsContainer);

                    if (events[dateId]) {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event-details';
                        eventDiv.textContent = events[dateId].text;
                        eventsContainer.appendChild(eventDiv);
                    }
                    
                    calendarGrid.appendChild(dayCell);
                }
            }
            
            async function showEventModal(dateId) {
                eventDateInput.value = dateId;
                eventModalTitle.textContent = `Cita para ${dateId}`;
                eventTextInput.value = events[dateId] ? events[dateId].text : '';
                eventModal.classList.remove('hidden');
            }

            calendarGrid.addEventListener('click', e => {
                if (e.target.closest('.calendar-day')) {
                    const dateId = e.target.closest('.calendar-day').dataset.date;
                    if (dateId) {
                        showEventModal(dateId);
                    }
                }
            });

            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            cancelEventBtn.addEventListener('click', () => eventModal.classList.add('hidden'));

            eventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const dateId = eventDateInput.value;
                const text = eventTextInput.value.trim();
                
                if (text) {
                    await setDoc(doc(db, "calendar_events", dateId), { text });
                } else {
                    await deleteDoc(doc(db, "calendar_events", dateId));
                }
                eventModal.classList.add('hidden');
            });
            
            onSnapshot(collection(db, "calendar_events"), (snapshot) => {
                events = {};
                snapshot.forEach(doc => {
                    events[doc.id] = doc.data();
                });
                renderCalendar();
            });
        }
        
        // --- Notification Logic ---
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                    }
                });
            }
        }

        function checkForReadyOrders(oldOrders, newOrders) {
            newOrders.forEach(newOrder => {
                const oldOrder = oldOrders.find(o => o.id === newOrder.id);
                if (newOrder.status === 'Listo' && oldOrder && oldOrder.status !== 'Listo') {
                    showNotification(`Mesa ${newOrder.tableNumber} está lista!`);
                }
            });
        }

        function showNotification(message) {
            if (Notification.permission === 'granted') {
                new Notification('¡Pedido Listo!', {
                    body: message,
                    icon: 'https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/imagen_2025-10-30_080250936.png'
                });
            }

            const notificationBanner = document.getElementById('notification-banner');
            const notificationMessage = document.getElementById('notification-message');
            notificationMessage.textContent = message;
            notificationBanner.classList.remove('hidden');
            notificationBanner.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                notificationBanner.style.transform = 'translateX(120%)';
                 setTimeout(() => {
                    notificationBanner.classList.add('hidden');
                }, 300);
            }, 5000);
        }

    </script>
</body>
</html>
