<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurante Regalo de Dios - Sistema de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales y tema futurista */
        body {
            font-family: 'Roboto Mono', monospace;
            background-image: url('https://rhainaizblawiktjlwsv.supabase.co/storage/v1/object/public/logos/imagen_2025-10-10_160304895.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        h1, h2, h3 {
            font-family: 'Orbitron', sans-serif;
            color: #00bcd4;
        }
        .header-bg, .form-panel, .modal-panel {
            background-color: rgba(30, 30, 46, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 188, 212, 0.2);
            box-shadow: 0 0 20px rgba(0, 188, 212, 0.3);
        }
        .container { max-width: 1400px; }
        .order-card {
            transition: all 0.3s ease;
            border-radius: 0.75rem;
            background-color: rgba(40, 40, 60, 0.8);
            border: 1px solid rgba(0, 188, 212, 0.2);
        }
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.4);
        }
        
        /* Estilos de estado y botones */
        .status-en-espera { border-left: 6px solid #ffeb3b; }
        .status-visto { border-left: 6px solid #00bcd4; }
        .status-listo { border-left: 6px solid #4caf50; }
        .status-cerrado { border-left: 6px solid #5a5a5a; }

        .view-button {
            background-color: rgba(0, 188, 212, 0.1);
            color: #00bcd4;
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 188, 212, 0.3);
        }
        .view-button.active {
            background-color: #00bcd4;
            color: white;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.6);
        }
        .view-button:hover:not(.active) {
            background-color: rgba(0, 188, 212, 0.2);
        }

        .primary-btn {
            background-color: #00bcd4;
            color: white;
            transition: all 0.2s ease;
        }
        .primary-btn:hover {
            background-color: #00e5ff;
        }
        .primary-btn:disabled {
            background-color: #5a5a5a;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Estilos de inputs y otros elementos */
        .form-panel input, .form-panel select, .form-panel textarea {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 188, 212, 0.3);
            color: white;
        }
        .golden-text {
            color: #ffcf40;
            text-shadow: 0 0 8px #ffcf40;
        }
        .login-watermark {
            color: #e0e0e0;
            opacity: 0.2;
        }
        .status-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-icon-en-espera { background-color: #ffeb3b; }
        .status-icon-visto { background-color: #00bcd4; }
        .status-icon-listo { background-color: #4caf50; }
        .status-icon-cerrado { background-color: #5a5a5a; }

        /* Estilos para la impresión del tiquete */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: 'Courier New', monospace; font-size: 9pt; color: #000;
            }
            #print-area h1 { font-size: 12pt; text-align: center; }
            #print-area p { margin: 2px 0; }
            #print-area ul { list-style-type: none; padding: 5px 0; margin: 5px 0; border-top: 1px dashed #000; border-bottom: 1px dashed #000; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Pantalla de Contraseña -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div id="password-box" class="modal-panel p-8 rounded-lg text-center w-full max-w-sm">
            <img src="https://rhainaizblawiktjlwsv.supabase.co/storage/v1/object/public/logos/imagen_2025-10-10_160555537.png" alt="Logo Regalo de Dios" class="mx-auto h-24 w-24 object-contain rounded-full shadow-md mb-6">
            <h2 class="text-2xl font-bold mb-4 text-white">Ingresar Contraseña</h2>
            <form id="password-form">
                <input type="password" id="password-input" class="w-full p-3 rounded-md text-center bg-gray-700 text-white" placeholder="********">
                <p id="error-message" class="text-red-400 text-sm mt-2 hidden">Contraseña incorrecta.</p>
                <button type="submit" class="w-full primary-btn py-3 rounded-md text-lg font-semibold mt-6">Acceder</button>
            </form>
            <p class="login-watermark mt-4">CREADO POR FABIAN CARVAJAL</p>
        </div>
    </div>

    <!-- Panel de Administrador -->
    <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="modal-panel p-8 rounded-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-white text-center">Panel de Administrador</h2>
            <div class="space-y-4">
                <label for="admin-days-input" class="block text-sm font-medium text-blue-200">Días para ajustar el temporizador:</label>
                <input type="number" id="admin-days-input" class="w-full p-3 rounded-md bg-gray-700 text-white" placeholder="Ej: 10">
                <div class="flex space-x-4">
                    <button id="add-days-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md font-semibold">Añadir Días</button>
                    <button id="remove-days-btn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-md font-semibold">Quitar Días</button>
                </div>
                <p id="admin-feedback" class="text-green-400 text-sm mt-2 h-4 text-center"></p>
            </div>
            <button id="admin-logout-btn" class="w-full bg-gray-700 text-cyan-400 hover:bg-gray-600 py-2 mt-8 rounded-md font-semibold border border-cyan-400">Volver</button>
        </div>
    </div>
    
    <!-- Modal de Confirmación Genérico -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="modal-panel p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <h2 id="confirm-title" class="text-2xl font-bold mb-4 text-white">Confirmar Acción</h2>
            <p id="confirm-message" class="text-gray-300 mb-6">¿Estás seguro?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-btn" class="px-8 py-2 bg-red-800 hover:bg-red-900 rounded-md font-semibold">Sí</button>
                <button id="confirm-no-btn" class="px-8 py-2 bg-gray-600 hover:bg-gray-700 rounded-md font-semibold">No</button>
            </div>
        </div>
    </div>

    <!-- Modal de Cerrar Sesión / Cerrar Día -->
    <div id="logout-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="modal-panel p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-white">¿Qué deseas hacer?</h2>
            <p id="logout-info" class="text-gray-300 mb-6">Puedes cerrar tu sesión temporalmente o realizar el cierre de caja del día.</p>
            <div class="space-y-4">
                <button id="close-day-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-md font-semibold">Cerrar Día y Imprimir Reporte</button>
                <button id="just-logout-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-md font-semibold">Cerrar Sesión por ahora</button>
                <button id="cancel-logout-btn" class="w-full text-cyan-400 hover:text-white py-2 mt-4 rounded-md">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Cobro -->
    <div id="payment-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="modal-panel p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold mb-6 text-center text-cyan-400">Realizar Cobro</h2>
            <div class="space-y-4 text-lg">
                <div class="flex justify-between items-center">
                    <span class="text-gray-300">Total a Pagar:</span>
                    <span id="payment-total" class="font-bold text-yellow-400">₡0</span>
                </div>
                <div class="flex justify-between items-center">
                    <label for="payment-paid" class="text-gray-300">Paga con:</label>
                    <input type="number" id="payment-paid" class="w-1/2 p-2 rounded-md bg-gray-700 text-white text-right" placeholder="0">
                </div>
                <div class="flex justify-between items-center text-xl">
                    <span class="text-gray-300">Vuelto:</span>
                    <span id="payment-change" class="font-bold text-green-400">₡0</span>
                </div>
            </div>
            <div class="flex justify-center space-x-4 mt-8">
                <button id="finalize-payment-btn" class="flex-1 primary-btn py-3 rounded-md font-semibold" disabled>Finalizar, Imprimir y Cerrar</button>
                <button id="cancel-payment-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 rounded-md font-semibold">Cancelar</button>
            </div>
        </div>
    </div>


    <!-- Contenido Principal de la Aplicación -->
    <div class="container mx-auto p-4 hidden">
        <header class="header-bg rounded-lg p-6 mb-8 text-center relative">
            <div class="absolute top-4 left-4 text-left">
                <p class="text-xs font-semibold text-cyan-400">Tiempo restante:</p>
                <p id="countdown-timer" class="text-lg font-bold text-yellow-400">Cargando...</p>
            </div>
            <button id="logoutBtn" class="absolute top-4 right-4 bg-gray-700 text-cyan-400 hover:bg-gray-600 px-4 py-1.5 rounded-full text-sm font-semibold border border-cyan-400">Cerrar Sesión</button>
            <p id="live-clock" class="absolute top-12 right-4 text-xs font-semibold text-cyan-400"></p>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <img src="https://rhainaizblawiktjlwsv.supabase.co/storage/v1/object/public/logos/imagen_2025-10-10_160555537.png" alt="Logo Regalo de Dios" class="h-16 w-16 object-contain rounded-full shadow-md">
                <h1 class="text-4xl font-bold leading-tight golden-text">Restaurante Regalo de Dios</h1>
            </div>
            <div class="flex justify-center items-center mt-6 space-x-3">
                <button id="showCashierViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Vista Caja</button>
                <button id="showKitchenViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Vista Cocina</button>
                <button id="showHistoryViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Historial</button>
                <button id="showReportsViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Reportes</button>
            </div>
             <div id="auth-status" class="text-center mt-4 text-sm text-gray-400">Conectando a Firebase...</div>
        </header>

        <!-- Vista Caja -->
        <div id="cashierView">
             <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="lg:col-span-2 lg:sticky lg:top-8">
                    <div class="form-panel p-8 rounded-lg">
                        <h2 class="text-3xl font-bold mb-6 text-center text-cyan-400">Crear Nuevo Pedido</h2>
                        <form id="orderForm" class="space-y-6">
                            <div>
                                <label for="tableNumber" class="block text-sm font-medium text-blue-200 mb-1">Número de Mesa</label>
                                <select id="tableNumber" required class="w-full bg-gray-700 text-white rounded-md p-3"></select>
                            </div>
                            <div>
                                <label for="orderItems" class="block text-sm font-medium text-blue-200 mb-1">Artículos del Pedido</label>
                                <textarea id="orderItems" rows="5" required class="w-full p-3 text-white bg-gray-700 rounded-md" placeholder="Ej:\n1 Hamburguesa\n1 Papas fritas"></textarea>
                            </div>
                             <div class="mt-4">
                                <h4 class="text-lg font-bold text-cyan-300 mb-2">Menú Rápido</h4>
                                 <div id="menu-categories" class="flex flex-wrap gap-2 border-b border-cyan-800 pb-2 mb-2">
                                    <!-- Category buttons will be injected here -->
                                </div>
                                <div id="menuItemsContainer" class="flex flex-wrap gap-2 max-h-48 overflow-y-auto">
                                    <!-- Menu items will be injected here -->
                                </div>
                            </div>
                            <div class="flex space-x-2 mt-6">
                                <button id="send-to-kitchen-btn" type="button" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white py-3 rounded-md font-semibold">Enviar a Cocina</button>
                                <button id="print-and-send-btn" type="button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-md font-semibold">Imprimir y Enviar</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-3">
                     <div class="form-panel p-8 rounded-lg">
                        <h3 class="text-3xl font-bold mb-6 text-center text-cyan-400">Estado de Mesas Activas</h3>
                        <div id="cashierOrders" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Cocina -->
        <div id="kitchenView" class="hidden">
            <h2 class="text-3xl font-bold mb-6 text-center text-cyan-400">Pedidos Activos en Cocina</h2>
            <div id="kitchenOrders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>

        <!-- Vista Historial -->
        <div id="historyView" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-cyan-400">Historial de Pedidos</h2>
                <button id="deleteAllHistoryBtn" class="bg-red-800 text-white px-4 py-2 rounded-md hover:bg-red-900 text-sm font-semibold">Borrar todo el historial</button>
            </div>
            <div id="historyOrders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>

        <!-- Vista Reportes -->
        <div id="reportsView" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 form-panel p-8 rounded-lg">
                    <h2 id="report-date-display" class="text-3xl font-bold mb-6 text-center text-cyan-400">Reporte del Día</h2>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-2xl font-bold text-cyan-300 mb-4">Ventas Totales</h3>
                            <p id="total-sales" class="text-4xl font-bold text-yellow-400">₡0</p>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-cyan-300 mb-4">Resumen de Platillos Vendidos</h3>
                            <div id="top-items-list" class="space-y-2 max-h-96 overflow-y-auto pr-4">
                               <p class="text-gray-400">No hay datos para mostrar.</p>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="form-panel p-8 rounded-lg">
                    <h3 class="text-2xl font-bold text-cyan-300 mb-4">Cierres de Día Guardados</h3>
                    <div id="past-reports-list" class="space-y-2 max-h-[calc(100vh-20rem)] overflow-y-auto">
                        <p class="text-gray-400">No hay reportes guardados.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Área de Impresión (oculta) -->
    <div id="print-area" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs, serverTimestamp, setLogLevel, getDoc, setDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Selectores de Elementos del DOM ---
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');
        const mainContainer = document.querySelector('.container');
        const logoutBtn = document.getElementById('logoutBtn');
        const liveClockEl = document.getElementById('live-clock');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const authStatusEl = document.getElementById('auth-status');
        
        const cashierView = document.getElementById('cashierView');
        const kitchenView = document.getElementById('kitchenView');
        const historyView = document.getElementById('historyView');
        const reportsView = document.getElementById('reportsView');
        const showCashierViewBtn = document.getElementById('showCashierViewBtn');
        const showKitchenViewBtn = document.getElementById('showKitchenViewBtn');
        const showHistoryViewBtn = document.getElementById('showHistoryViewBtn');
        const showReportsViewBtn = document.getElementById('showReportsViewBtn');
        
        const orderForm = document.getElementById('orderForm');
        const tableNumberSelect = document.getElementById('tableNumber');
        const orderItemsTextarea = document.getElementById('orderItems');
        const kitchenOrdersContainer = document.getElementById('kitchenOrders');
        const cashierOrdersContainer = document.getElementById('cashierOrders');
        const historyOrdersContainer = document.getElementById('historyOrders');
        const deleteAllHistoryBtn = document.getElementById('deleteAllHistoryBtn');
        
        const adminPanel = document.getElementById('admin-panel');
        const adminDaysInput = document.getElementById('admin-days-input');
        const addDaysBtn = document.getElementById('add-days-btn');
        const removeDaysBtn = document.getElementById('remove-days-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminFeedback = document.getElementById('admin-feedback');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let confirmCallback = null;
        
        // Logout/Close Day Modal selectors
        const logoutConfirmModal = document.getElementById('logout-confirm-modal');
        const closeDayBtn = document.getElementById('close-day-btn');
        const justLogoutBtn = document.getElementById('just-logout-btn');
        const cancelLogoutBtn = document.getElementById('cancel-logout-btn');

        // Menu selectors
        const menuItemsContainer = document.getElementById('menuItemsContainer');
        
        // Payment Modal selectors
        const paymentModal = document.getElementById('payment-modal');
        const paymentTotalEl = document.getElementById('payment-total');
        const paymentPaidInput = document.getElementById('payment-paid');
        const paymentChangeEl = document.getElementById('payment-change');
        const finalizePaymentBtn = document.getElementById('finalize-payment-btn');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        let currentOrderForPayment = null;

        // Reports selectors
        const reportDateDisplay = document.getElementById('report-date-display');
        const totalSalesEl = document.getElementById('total-sales');
        const topItemsListEl = document.getElementById('top-items-list');
        const pastReportsListEl = document.getElementById('past-reports-list');

        let db, auth;
        let currentUserPassword = '1234'; // Variable para la contraseña
        
        // --- TU PROPIA CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7OIars9qrTeZo3-tFxqCeGwTA5CmZeng",
            authDomain: "posdeventaregalodedios.firebaseapp.com",
            projectId: "posdeventaregalodedios",
            storageBucket: "posdeventaregalodedios.appspot.com",
            messagingSenderId: "883274283691",
            appId: "1:883274283691:web:ed88029e2faf58245c55ee",
            measurementId: "G-WD5KPNQRPC"
        };
        
        // --- Lógica de la Aplicación ---
        
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            if (password === currentUserPassword) {
                passwordModal.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                initializeFirebase();
            } else if (password === '2004') {
                passwordModal.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                 if (!db) initializeFirebase();
            }
            else {
                errorMessage.classList.remove('hidden');
                passwordInput.value = '';
            }
        });
        passwordInput.addEventListener('input', () => errorMessage.classList.add('hidden'));
        
        logoutBtn.addEventListener('click', () => logoutConfirmModal.classList.remove('hidden'));
        cancelLogoutBtn.addEventListener('click', () => logoutConfirmModal.classList.add('hidden'));
        justLogoutBtn.addEventListener('click', () => location.reload());
        closeDayBtn.addEventListener('click', handleCloseDay);

        adminLogoutBtn.addEventListener('click', () => {
            adminPanel.classList.add('hidden');
            passwordModal.classList.remove('hidden');
        });

        async function initializeFirebase() {
            if (db) return; 
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        authStatusEl.textContent = `Conectado a tu Firebase`;
                        authStatusEl.style.color = '#4ade80';
                        if (!mainContainer.classList.contains('hidden') || !adminPanel.classList.contains('hidden')) {
                           await seedMenuData();
                           initializeApplication();
                        }
                    } else {
                        authStatusEl.textContent = "Autenticando...";
                        authStatusEl.style.color = '#ffeb3b';
                    }
                });
                
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                authStatusEl.style.color = '#ef4444';
                if (error.code === 'auth/configuration-not-found') {
                    const authUrl = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication/providers`;
                    authStatusEl.innerHTML = `<b>Error:</b> Habilita "Authentication" y el proveedor "Anónimo". <a href="${authUrl}" target="_blank" class="text-cyan-400 underline">Clic aquí para ir a la configuración.</a>`;
                } else {
                    authStatusEl.textContent = "Error de conexión con tu Firebase.";
                }
            }
        }

        function initializeApplication() {
            populateTableNumbers();
            switchView('cashier');
            updateClock();
            setInterval(updateClock, 1000);
            startCountdown();
            listenToOrders();
            listenToMenu();
            listenToDailyReports();
        }

        function populateTableNumbers() {
            tableNumberSelect.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Mesa ${i}`;
                tableNumberSelect.appendChild(option);
            }
        }
        
        function switchView(view) {
            [cashierView, kitchenView, historyView, reportsView].forEach(v => v.classList.add('hidden'));
            [showCashierViewBtn, showKitchenViewBtn, showHistoryViewBtn, showReportsViewBtn].forEach(b => b.classList.remove('active'));
            if (view === 'cashier') {
                cashierView.classList.remove('hidden');
                showCashierViewBtn.classList.add('active');
            } else if (view === 'kitchen') {
                kitchenView.classList.remove('hidden');
                showKitchenViewBtn.classList.add('active');
            } else if (view === 'history') {
                historyView.classList.remove('hidden');
                showHistoryViewBtn.classList.add('active');
            } else if (view === 'reports') {
                reportsView.classList.remove('hidden');
                showReportsViewBtn.classList.add('active');
                generateCurrentDayReport(); 
            }
        }
        showCashierViewBtn.addEventListener('click', () => switchView('cashier'));
        showKitchenViewBtn.addEventListener('click', () => switchView('kitchen'));
        showHistoryViewBtn.addEventListener('click', () => switchView('history'));
        showReportsViewBtn.addEventListener('click', () => switchView('reports'));
        
        const sendToKitchenBtn = document.getElementById('send-to-kitchen-btn');
        const printAndSendBtn = document.getElementById('print-and-send-btn');
        
        sendToKitchenBtn.addEventListener('click', () => submitOrder(false));
        printAndSendBtn.addEventListener('click', () => submitOrder(true));

        async function submitOrder(print = false) {
            const items = orderItemsTextarea.value.trim().split('\n').filter(Boolean);
            if (items.length === 0) return;
            const tableNumber = parseInt(tableNumberSelect.value);

            if(print) {
                const tempOrder = { tableNumber, items };
                printKitchenTicket(tempOrder);
            }

            try {
                await addDoc(collection(db, 'orders'), {
                    tableNumber,
                    items,
                    status: 'En espera',
                    createdAt: serverTimestamp(),
                    closedAt: null
                });
                orderItemsTextarea.value = '';
            } catch (error) {
                console.error("Error al añadir pedido:", error);
            }
        }

        function listenToOrders() {
            const q = query(collection(db, 'orders'));

            onSnapshot(q, (snapshot) => {
                let orders = [];
                snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
                renderAllOrders(orders);
            }, (error) => {
                console.error("Error al escuchar pedidos:", error);
            });
        }
        
        function renderAllOrders(orders) {
            kitchenOrdersContainer.innerHTML = '';
            cashierOrdersContainer.innerHTML = '';
            historyOrdersContainer.innerHTML = '';

            const activeOrders = orders.filter(o => o.status !== 'Cerrado');
            const closedOrders = orders.filter(o => o.status === 'Cerrado');
            
            if (activeOrders.length > 0) {
                 activeOrders.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); 
                activeOrders.forEach(order => {
                    kitchenOrdersContainer.appendChild(createOrderCard(order));
                    cashierOrdersContainer.appendChild(createCashierOrderCard(order));
                });
            } else {
                const noOrdersMsg = '<p class="text-center col-span-full text-gray-400 p-4">No hay pedidos activos.</p>';
                kitchenOrdersContainer.innerHTML = noOrdersMsg;
                cashierOrdersContainer.innerHTML = noOrdersMsg;
            }

            if (closedOrders.length > 0) {
                deleteAllHistoryBtn.classList.remove('hidden');
                closedOrders.sort((a, b) => (b.closedAt?.seconds || 0) - (a.closedAt?.seconds || 0));
                closedOrders.forEach(order => historyOrdersContainer.appendChild(createHistoryOrderCard(order)));
            } else {
                deleteAllHistoryBtn.classList.add('hidden');
                historyOrdersContainer.innerHTML = '<p class="text-center col-span-full text-gray-400 p-4">No hay pedidos en el historial.</p>';
            }
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card flex flex-col justify-between status-${order.status.toLowerCase().replace(' ', '-')}`;
            const statusColors = { "En espera": "bg-yellow-400 text-yellow-900", "Visto": "bg-cyan-500 text-cyan-900", "Listo": "bg-emerald-500 text-emerald-900" };
            const statusIcons = { "En espera": "status-icon-en-espera", "Visto": "status-icon-visto", "Listo": "status-icon-listo" };
            const itemsHtml = order.items.map(item => `<li class="text-gray-200">${item}</li>`).join('');
            const time = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString('es-CR') : '...';

            card.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-white">Mesa ${order.tableNumber}</h3>
                        <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${statusColors[order.status]}">
                           <span class="status-icon ${statusIcons[order.status]}"></span>${order.status}
                        </span>
                    </div>
                    <ul class="list-disc list-inside space-y-1 mb-4">${itemsHtml}</ul>
                    <p class="text-xs text-gray-400">${time}</p>
                </div>
                <div class="flex space-x-2 p-4 pt-0">
                    ${order.status === 'En espera' ? `<button data-id="${order.id}" data-status="Visto" class="update-status-btn flex-1 bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded-md text-sm font-semibold">Marcar Visto</button>` : ''}
                    ${order.status === 'Visto' ? `<button data-id="${order.id}" data-status="Listo" class="update-status-btn flex-1 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-md text-sm font-semibold">Marcar Listo</button>` : ''}
                </div>`;
            return card;
        }

        function createCashierOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card flex flex-col justify-between status-${order.status.toLowerCase().replace(' ', '-')}`;
            const itemsHtml = order.items.map(item => `<li class="text-sm text-gray-300">${item}</li>`).join('');

            card.innerHTML = `
                <div class="p-4">
                     <h3 class="text-lg font-bold text-white">Mesa ${order.tableNumber}</h3>
                     <p class="text-xs text-gray-400 mb-2">Estado: ${order.status}</p>
                     <ul class="list-disc list-inside space-y-1">${itemsHtml}</ul>
                </div>
                <div class="mt-auto p-4 pt-0">
                    ${order.status === 'Listo' ? `<button data-id="${order.id}" data-order='${JSON.stringify(order)}' class="close-order-btn w-full bg-emerald-600 text-white px-3 py-1.5 rounded-md hover:bg-emerald-700 text-sm font-semibold">Cobrar, Imprimir y Cerrar</button>` : `<div class="text-center text-sm font-medium text-gray-400 pt-2">Pedido en preparación...</div>`}
                </div>`;
            return card;
        }

        function createHistoryOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card status-cerrado`;
            const itemsHtml = order.items.map(item => `<li class="text-sm text-gray-300">${item}</li>`).join('');
            const closedTime = order.closedAt ? new Date(order.closedAt.seconds * 1000).toLocaleString('es-CR') : 'N/A';
            card.innerHTML = `
                <div class="p-4">
                    <h3 class="text-lg font-bold text-white">Mesa ${order.tableNumber}</h3>
                    <p class="text-xs text-gray-400 mb-2">Cerrado el: ${closedTime}</p>
                    <ul class="list-disc list-inside space-y-1">${itemsHtml}</ul>
                </div>
                <div class="mt-auto p-4 pt-0 flex space-x-2">
                    <button data-order='${JSON.stringify(order)}' class="reprint-btn flex-1 bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded-md text-sm font-semibold">Re-imprimir</button>
                    <button data-id="${order.id}" class="delete-order-btn flex-1 bg-red-800 text-white px-3 py-1.5 rounded-md hover:bg-red-900 text-sm font-semibold">Borrar</button>
                </div>`;
            return card;
        }

        const handleCardClick = async (e) => {
            const target = e.target;
            const collectionPath = "orders";
            
            if (target.classList.contains('update-status-btn')) {
                const { id, status } = target.dataset;
                await updateDoc(doc(db, collectionPath, id), { status });
            }
            if (target.classList.contains('close-order-btn')) {
                const orderData = JSON.parse(target.dataset.order);
                showPaymentModal(orderData);
            }
            if (target.classList.contains('reprint-btn')) {
                const { order } = target.dataset;
                const orderData = JSON.parse(order);
                printTicket(orderData.tableNumber, orderData.items, orderData.total);
            }
            if (target.classList.contains('delete-order-btn')) {
                const { id } = target.dataset;
                showConfirm("Borrar Pedido", "¿Estás seguro?", async () => {
                   await deleteDoc(doc(db, collectionPath, id));
                });
            }
        };
        
        kitchenOrdersContainer.addEventListener('click', handleCardClick);
        cashierOrdersContainer.addEventListener('click', handleCardClick);
        historyOrdersContainer.addEventListener('click', handleCardClick);

        deleteAllHistoryBtn.addEventListener('click', () => {
             showConfirm("Borrar TODO el Historial", "¿Estás seguro? Esta acción no se puede deshacer.", async () => {
                const q = query(collection(db, "orders"), where("status", "==", "Cerrado"));
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
            });
        });

        // --- Menu Logic ---
        function listenToMenu() {
            if (!db) return;
            const collectionPath = `menu`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                const menuItems = [];
                snapshot.forEach(doc => menuItems.push({ id: doc.id, ...doc.data() }));

                const groupedMenu = menuItems.reduce((acc, item) => {
                    const { category } = item;
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(item);
                    return acc;
                }, {});

                for (const category in groupedMenu) {
                    groupedMenu[category].sort((a, b) => a.name.localeCompare(b.name));
                }
                
                const sortedCategories = Object.keys(groupedMenu).sort();
                
                renderMenuForCashier(groupedMenu, sortedCategories);
            }, (error) => {
                console.error("Error listening to menu:", error);
            });
        }

        function renderMenuForCashier(groupedMenu, categories) {
            const menuCategoriesContainer = document.getElementById('menu-categories');
            menuCategoriesContainer.innerHTML = '';
            
            if (categories.length === 0) {
                document.getElementById('menuItemsContainer').innerHTML = '<p class="text-gray-400 text-sm">Cargando menú...</p>';
                return;
            }

            categories.forEach((category, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'category-btn text-sm px-3 py-1 rounded-full transition-colors';
                button.textContent = category;
                button.dataset.category = category;
                
                if (index === 0) {
                    button.classList.add('bg-cyan-600', 'text-white');
                } else {
                    button.classList.add('bg-gray-700', 'text-cyan-200');
                }

                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.category-btn').forEach(btn => {
                        btn.classList.remove('bg-cyan-600', 'text-white');
                        btn.classList.add('bg-gray-700', 'text-cyan-200');
                    });
                    button.classList.add('bg-cyan-600', 'text-white');
                    button.classList.remove('bg-gray-700', 'text-cyan-200');
                    renderMenuItems(groupedMenu[category]);
                });
                menuCategoriesContainer.appendChild(button);
            });

            if (categories.length > 0) {
               renderMenuItems(groupedMenu[categories[0]]);
            }
        }

        function renderMenuItems(items) {
            const menuItemsContainer = document.getElementById('menuItemsContainer');
            menuItemsContainer.innerHTML = '';
            items.forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'bg-cyan-800 hover:bg-cyan-700 text-cyan-200 text-sm px-3 py-1.5 rounded-full transition-colors';
                button.textContent = item.name;
                button.addEventListener('click', () => {
                    orderItemsTextarea.value += (orderItemsTextarea.value ? '\n' : '') + `1 ${item.name} - ₡${item.price}`;
                    orderItemsTextarea.focus();
                });
                menuItemsContainer.appendChild(button);
            });
        }
        
        // --- Payment Modal Logic ---
        function calculateTotal(items) {
            return items.reduce((total, item) => {
                const priceMatch = item.match(/₡(\d+)/);
                if (priceMatch && priceMatch[1]) {
                    const quantityMatch = item.match(/^(\d+)\s/);
                    const quantity = quantityMatch ? parseInt(quantityMatch[1], 10) : 1;
                    return total + (parseInt(priceMatch[1], 10) * quantity);
                }
                return total;
            }, 0);
        }

        function showPaymentModal(order) {
            currentOrderForPayment = order;
            const total = calculateTotal(order.items);
            paymentTotalEl.textContent = `₡${total.toLocaleString('es-CR')}`;
            paymentPaidInput.value = '';
            paymentChangeEl.textContent = '₡0';
            finalizePaymentBtn.disabled = true;
            paymentModal.classList.remove('hidden');
            paymentPaidInput.focus();
        }

        paymentPaidInput.addEventListener('input', () => {
            const total = calculateTotal(currentOrderForPayment.items);
            const paid = parseInt(paymentPaidInput.value, 10) || 0;
            const change = paid - total;
            
            if (change >= 0) {
                paymentChangeEl.textContent = `₡${change.toLocaleString('es-CR')}`;
                finalizePaymentBtn.disabled = false;
            } else {
                paymentChangeEl.textContent = '₡0';
                finalizePaymentBtn.disabled = true;
            }
        });

        cancelPaymentBtn.addEventListener('click', () => {
            paymentModal.classList.add('hidden');
            currentOrderForPayment = null;
        });

        finalizePaymentBtn.addEventListener('click', async () => {
            const total = calculateTotal(currentOrderForPayment.items);
            const paid = parseInt(paymentPaidInput.value, 10);
            const change = paid - total;
            
            printTicket(currentOrderForPayment.tableNumber, currentOrderForPayment.items, total, paid, change);
            
            const collectionPath = "orders";
            await updateDoc(doc(db, collectionPath, currentOrderForPayment.id), { 
                status: "Cerrado", 
                closedAt: serverTimestamp(),
                total: total
            });
            
            paymentModal.classList.add('hidden');
            currentOrderForPayment = null;
        });


        // --- Other Logic ---
        function printTicket(tableNumber, items, total, paid, change) {
            const printArea = document.getElementById('print-area');
            const formattedDate = new Date().toLocaleString('es-CR', { timeZone: 'America/Costa_Rica' });
            const itemsHtml = items.map(item => `<li>${item}</li>`).join('');
            
            let paymentHtml = '';
            if (total !== undefined && paid !== undefined && change !== undefined) {
                 paymentHtml = `
                    <p>----------------------------------------</p>
                    <p><strong>Total: ₡${total.toLocaleString('es-CR')}</strong></p>
                    <p>Paga con: ₡${paid.toLocaleString('es-CR')}</p>
                    <p>Vuelto: ₡${change.toLocaleString('es-CR')}</p>
                 `;
            } else if (total !== undefined) {
                 paymentHtml = `
                    <p>----------------------------------------</p>
                    <p><strong>Total: ₡${total.toLocaleString('es-CR')}</strong></p>
                 `;
            }

            printArea.innerHTML = `
                <div style="text-align: center; margin-bottom: 10px;">
                    <img src="https://rhainaizblawiktjlwsv.supabase.co/storage/v1/object/public/logos/imagen_2025-10-10_160555537.png" alt="Logo" style="width: 80px; margin: 0 auto;"/>
                </div>
                <h1 style="margin-bottom: 5px;">Restaurante Regalo de Dios</h1>
                <p style="text-align: center;">Tel: +506 6010 6552</p>
                <p>----------------------------------------</p>
                <p>Fecha: ${formattedDate}</p>
                <p>Mesa: ${tableNumber}</p>
                <ul>${itemsHtml}</ul>
                ${paymentHtml}
                <p style="text-align: center; margin-top: 10px;">¡Gracias por su visita!</p>`;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }
        
        function printKitchenTicket(order) {
            const printArea = document.getElementById('print-area');
            const formattedDate = new Date().toLocaleString('es-CR', { timeZone: 'America/Costa_Rica' });
            const itemsHtml = order.items.map(item => `<li>${item}</li>`).join('');

            printArea.innerHTML = `
                <h1 style="font-size: 16pt;">COMANDA - Mesa ${order.tableNumber}</h1>
                <p>Hora: ${formattedDate}</p>
                <ul style="font-size: 11pt;">${itemsHtml}</ul>
            `;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }
        
        function printDailyReport(totalSales, itemCounts, orderCount) {
             const printArea = document.getElementById('print-area');
            const formattedDate = new Date().toLocaleString('es-CR', { timeZone: 'America/Costa_Rica' });
            const topItemsHtml = Object.entries(itemCounts).sort(([,a],[,b]) => b-a).map(([name, count]) => `<li>${count}x - ${name}</li>`).join('');

            printArea.innerHTML = `
                <div style="text-align: center; margin-bottom: 10px;">
                    <img src="https://rhainaizblawiktjlwsv.supabase.co/storage/v1/object/public/logos/imagen_2025-10-10_160555537.png" alt="Logo" style="width: 80px; margin: 0 auto;"/>
                </div>
                <h1>CIERRE DE CAJA (CORTE Z)</h1>
                <p style="text-align: center;">Restaurante Regalo de Dios</p>
                <p style="text-align: center;">Tel: +506 6010 6552</p>
                <p>----------------------------------------</p>
                <p>Fecha de Cierre: ${formattedDate}</p>
                <p>----------------------------------------</p>
                <p><strong>Venta Total del Día: ₡${totalSales.toLocaleString('es-CR')}</strong></p>
                <p>Pedidos Totales: ${orderCount}</p>
                <p>----------------------------------------</p>
                <h3>Platillos Vendidos:</h3>
                <ul>${topItemsHtml}</ul>
            `;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }

        async function handleCloseDay() {
            logoutConfirmModal.classList.add('hidden');

            const qOrders = query(collection(db, "orders"));
            const orderSnapshot = await getDocs(qOrders);
            const allOrders = orderSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

            const activeOrders = allOrders.filter(order => order.status !== 'Cerrado');

            if (activeOrders.length > 0) {
                const activeTables = activeOrders.map(o => o.tableNumber).join(', ');
                const errorMessage = `No se puede cerrar el día. Las siguientes mesas tienen pedidos activos: Mesa ${activeTables}. Por favor, ciérralos desde la Vista Caja.`;
                showConfirm("Error", errorMessage, () => {});
                confirmYesBtn.classList.add('hidden');
                confirmNoBtn.textContent = 'Entendido';
                confirmNoBtn.onclick = () => {
                    confirmModal.classList.add('hidden');
                    confirmYesBtn.classList.remove('hidden');
                    confirmNoBtn.textContent = 'No';
                };
                return;
            }
            
            const closedDocs = orderSnapshot.docs.filter(doc => doc.data().status === 'Cerrado');
            
            if(closedDocs.length === 0) {
                showConfirm("Cierre de Día", "No hay ventas facturadas para cerrar.", () => location.reload());
                 confirmYesBtn.classList.add('hidden');
                 confirmNoBtn.textContent = 'OK';
                 confirmNoBtn.onclick = () => location.reload();
                return;
            }

            let totalSales = 0;
            const itemCounts = {};
            
            closedDocs.forEach(doc => {
                const order = doc.data();
                totalSales += order.total || 0;
                order.items.forEach(itemString => {
                    const itemName = itemString.replace(/^\d+\s/, '').replace(/\s-\s₡\d+$/, '').trim();
                    itemCounts[itemName] = (itemCounts[itemName] || 0) + 1;
                });
            });

            printDailyReport(totalSales, itemCounts, closedDocs.length);

            const reportDate = new Date();
            const reportId = `${reportDate.getFullYear()}-${String(reportDate.getMonth() + 1).padStart(2, '0')}-${String(reportDate.getDate()).padStart(2, '0')}`;
            const reportData = {
                date: serverTimestamp(),
                totalSales,
                itemCounts,
                orderCount: closedDocs.length
            };
            await setDoc(doc(db, "daily_reports", reportId), reportData);

            const deletePromises = closedDocs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deletePromises);
            
            showConfirm("¡Éxito!", "El día ha sido cerrado y el reporte se ha impreso y guardado.", () => location.reload());
            confirmYesBtn.classList.add('hidden');
            confirmNoBtn.textContent = 'OK';
            confirmNoBtn.onclick = () => location.reload();
        }


        function updateClock() {
            liveClockEl.textContent = new Date().toLocaleTimeString('es-CR', { timeZone: 'America/Costa_Rica' });
        }
        
        let countdownInterval;
        async function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            if (!db) return;

            const countdownDocRef = doc(db, "config", 'countdown');
            
            try {
                const docSnap = await getDoc(countdownDocRef);
                let targetTimestamp;

                if (docSnap.exists()) {
                    targetTimestamp = docSnap.data().targetTimestamp;
                } else {
                    const defaultDate = new Date();
                    defaultDate.setFullYear(defaultDate.getFullYear() + 1);
                    targetTimestamp = defaultDate.getTime();
                    await setDoc(countdownDocRef, { targetTimestamp });
                }
                
                countdownInterval = setInterval(() => {
                    const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Costa_Rica' }));
                    const distance = targetTimestamp - now.getTime();
                    if (distance < 0) {
                        clearInterval(countdownInterval);
                        countdownTimerEl.innerHTML = "¡Finalizado!";
                        currentUserPassword = '8873';
                        return;
                    }
                    const d = Math.floor(distance / 86400000), h = Math.floor((distance % 86400000) / 3600000), m = Math.floor((distance % 3600000) / 60000), s = Math.floor((distance % 60000) / 1000);
                    countdownTimerEl.innerHTML = `${d}d ${h}h ${m}m ${s}s`;
                }, 1000);

            } catch(error) {
                console.error("Error al cargar temporizador:", error);
                countdownTimerEl.textContent = "Error";
            }
        }
        
        async function updateCountdownAdmin(days, operation) {
            const daysToAdjust = parseInt(days);
            if (isNaN(daysToAdjust)) {
                adminFeedback.textContent = "Ingrese un número válido."; return;
            }
            if (!db) {
                adminFeedback.textContent = "Error: base de datos no conectada."; return;
            }
            
            const countdownDocRef = doc(db, "config", 'countdown');

            try {
                 const docSnap = await getDoc(countdownDocRef);
                 if (!docSnap.exists()) {
                     await startCountdown(); 
                 }
                 
                 const currentTimestamp = (await getDoc(countdownDocRef)).data().targetTimestamp;
                 const currentDate = new Date(currentTimestamp);

                 if (operation === 'add') {
                    currentDate.setDate(currentDate.getDate() + daysToAdjust);
                 } else {
                    currentDate.setDate(currentDate.getDate() - daysToAdjust);
                 }

                 await setDoc(countdownDocRef, { targetTimestamp: currentDate.getTime() });

                 adminFeedback.textContent = "¡Fecha actualizada!";
                 adminDaysInput.value = '';
                 startCountdown(); 
                 setTimeout(() => adminFeedback.textContent = '', 3000);

            } catch (error) {
                console.error("Error actualizando temporizador:", error);
                adminFeedback.textContent = "Error al actualizar.";
            }
        }
        addDaysBtn.addEventListener('click', () => updateCountdownAdmin(adminDaysInput.value, 'add'));
        removeDaysBtn.addEventListener('click', () => updateCountdownAdmin(adminDaysInput.value, 'remove'));

        // --- Reports Logic ---

        function displayReportData(title, data) {
            reportDateDisplay.textContent = title;
            totalSalesEl.textContent = `₡${(data.totalSales || 0).toLocaleString('es-CR')}`;
            
            const sortedItems = Object.entries(data.itemCounts || {}).sort(([, a], [, b]) => b - a);

            topItemsListEl.innerHTML = '';
            if (sortedItems.length === 0) {
                topItemsListEl.innerHTML = '<p class="text-gray-400">No hay datos para mostrar.</p>';
            } else {
                sortedItems.forEach(([name, count]) => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center text-gray-300";
                    div.innerHTML = `<span>${name}</span> <span class="font-bold text-cyan-400">${count}</span>`;
                    topItemsListEl.appendChild(div);
                });
            }
        }

        async function generateCurrentDayReport() {
            if (!db) return;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const q = query(collection(db, "orders"), where("status", "==", "Cerrado"));
            const querySnapshot = await getDocs(q);

            let totalSales = 0;
            const itemCounts = {};

            querySnapshot.forEach(doc => {
                const order = doc.data();
                if (order.closedAt && order.closedAt.toDate() >= today) {
                    totalSales += order.total || 0;
                    order.items.forEach(itemString => {
                        const itemName = itemString.replace(/^\d+\s/, '').replace(/\s-\s₡\d+$/, '').trim();
                        itemCounts[itemName] = (itemCounts[itemName] || 0) + 1;
                    });
                }
            });

            displayReportData('Reporte de Hoy (En Vivo)', { totalSales, itemCounts });
        }
        
        function listenToDailyReports() {
             if (!db) return;
            const q = query(collection(db, "daily_reports"));

            onSnapshot(q, (snapshot) => {
                const reports = [];
                snapshot.forEach(doc => reports.push({ id: doc.id, ...doc.data() }));
                reports.sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0)); 
                
                pastReportsListEl.innerHTML = '';
                if(reports.length === 0) {
                    pastReportsListEl.innerHTML = '<p class="text-gray-400">No hay reportes guardados.</p>';
                    return;
                }

                reports.forEach(report => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-2 rounded-md hover:bg-cyan-800 transition-colors view-button';
                    button.textContent = report.id;
                    button.onclick = () => {
                         displayReportData(`Reporte de ${report.id}`, report);
                    };
                    pastReportsListEl.appendChild(button);
                });
            });
        }

        function showConfirm(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
             // Reset buttons
            confirmYesBtn.classList.remove('hidden');
            confirmNoBtn.textContent = 'No';
            confirmNoBtn.onclick = () => {
                confirmModal.classList.add('hidden');
                confirmCallback = null;
            };
        }
        confirmNoBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });
        confirmYesBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });
        
        async function seedMenuData() {
            if (!db) return;
            try {
                const menuCollection = collection(db, 'menu');
                const snapshot = await getDocs(query(menuCollection, limit(1)));

                if (snapshot.empty) {
                    console.log("Menu collection is empty. Seeding data...");
                    const menuData = [
                        { name: 'Típicos', price: 3500, category: 'Desayunos' },{ name: 'Desayuno Campesino', price: 3500, category: 'Desayunos' },{ name: 'Desayuno Delux', price: 4000, category: 'Desayunos' },{ name: 'Omelette (jamón, queso y espinaca)', price: 3200, category: 'Desayunos' },{ name: 'Tostadas Francesas', price: 3000, category: 'Desayunos' },{ name: 'Pancakes', price: 3000, category: 'Desayunos' },{ name: 'Fajitas (Pollo/Res)', price: 4000, category: 'Antojitos' },{ name: 'Quesadilla (Pollo/Carne)', price: 3700, category: 'Antojitos' },{ name: 'Quesadilla de Camarón', price: 4300, category: 'Antojitos' },{ name: 'Taco Tico de Carne', price: 3000, category: 'Antojitos' },{ name: 'Taco de la Casa (Mixto)', price: 5000, category: 'Antojitos' },{ name: 'Nachos (Carne/Pollo)', price: 3500, category: 'Antojitos' },{ name: 'Nachos Mixtos', price: 5000, category: 'Antojitos' },{ name: 'Papas Supremas (Pollo/Carne)', price: 3500, category: 'Antojitos' },{ name: 'Pollo Frito', price: 2500, category: 'Antojitos' },{ name: 'Bigorón', price: 3000, category: 'Antojitos' },{ name: 'Surtidas', price: 13500, category: 'Antojitos' },{ name: 'Sándwich de Carne', price: 3000, category: 'Antojitos' },{ name: 'Taco Grande con Papas', price: 3000, category: 'Antojitos' },{ name: 'Taco Pequeño con Papas', price: 2000, category: 'Antojitos' },{ name: 'Aliñadas', price: 3000, category: 'Antojitos' },{ name: 'Chorreadas', price: 4500, category: 'Antojitos' },{ name: 'Empanada Sencilla', price: 2000, category: 'Antojitos' },{ name: 'Empanada Arreglada', price: 2600, category: 'Antojitos' },{ name: 'Aros de Cebolla', price: 2000, category: 'Antojitos' },{ name: 'Chifrijo', price: 5000, category: 'Antojitos' },{ name: 'Nuggets de Pollo', price: 3500, category: 'Antojitos' },{ name: 'Dados de Pescado', price: 3500, category: 'Antojitos' },{ name: 'Patacones Arreglados', price: 3500, category: 'Antojitos' },{ name: 'Papas del Campo', price: 2000, category: 'Antojitos' },{ name: 'Papas Fritas', price: 1500, category: 'Antojitos' },{ name: 'Chicharrones', price: 4500, category: 'Antojitos' },{ name: 'Costilla a la BBQ', price: 7000, category: 'Antojitos' },{ name: 'Alitas de Pollo (6 pz)', price: 4500, category: 'Antojitos' },{ name: 'Alitas de Pollo (12 pz)', price: 8100, category: 'Antojitos' },{ name: 'Surtida Lux', price: 15000, category: 'Antojitos' },{ name: 'Parrillada Mixta', price: 9000, category: 'Antojitos' },{ name: 'Choripán', price: 5300, category: 'Antojitos' },{ name: 'Combo 1 (Hamb. Peq, Taco Peq, Papas)', price: 5000, category: 'Combos' },{ name: 'Combo 2 (Hot Dog, Taco, Papas)', price: 5000, category: 'Combos' },{ name: 'Casado Pechuga Pollo', price: 4000, category: 'Casados' },{ name: 'Casado Pescado', price: 4000, category: 'Casados' },{ name: 'Casado Chuleta', price: 4000, category: 'Casados' },{ name: 'Casado Carne en Salsa', price: 4000, category: 'Casados' },{ name: 'Casado Bistec', price: 4000, category: 'Casados' },{ name: 'Casado Pollo en Salsa', price: 4000, category: 'Casados' },{ name: 'Pechuga Pollo Parmesana', price: 5000, category: 'Platos Fuertes' },{ name: 'Pechuga Pollo a la Plancha', price: 5000, category: 'Platos Fuertes' },{ name: 'Arroz de la Casa', price: 5000, category: 'Platos Fuertes' },{ name: 'Arroz con Camarones', price: 5000, category: 'Platos Fuertes' },{ name: 'Churrasco', price: 7000, category: 'Platos Fuertes' },{ name: 'Costilla de Cerdo BBQ', price: 7000, category: 'Platos Fuertes' },{ name: 'Filete de Pescado', price: 5000, category: 'Platos Fuertes' },{ name: 'Pasta Alfredo', price: 5000, category: 'Platos Fuertes' },{ name: 'Pasta Boloñesa', price: 5000, category: 'Platos Fuertes' },{ name: 'Spaghetti con Camarones', price: 5000, category: 'Platos Fuertes' },{ name: 'Hamb. Pollo Pequeña', price: 2500, category: 'Hamburguesas' },{ name: 'Hamb. Pollo Grande', price: 5000, category: 'Hamburguesas' },{ name: 'Hamb. Torta de Carne Pequeña', price: 2500, category: 'Hamburguesas' },{ name: 'Hamb. Torta de Carne Grande', price: 5000, category: 'Hamburguesas' },{ name: 'Hamb. Carne Desmechada Pequeña', price: 2500, category: 'Hamburguesas' },{ name: 'Hamb. Carne Desmechada Grande', price: 5000, category: 'Hamburguesas' },{ name: 'Gallo de Papa', price: 1500, category: 'Gallos' },{ name: 'Gallo de Pollo', price: 1500, category: 'Gallos' },{ name: 'Gallo de Carne', price: 1500, category: 'Gallos' },{ name: 'Gallo de Salchichón', price: 1500, category: 'Gallos' },{ name: 'Gallo de Torta de Huevo', price: 1500, category: 'Gallos' },{ name: 'Gallo de Carne en Salsa', price: 1500, category: 'Gallos' },{ name: 'Gallo de Chorizo', price: 1500, category: 'Gallos' },{ name: 'Gallo de Pescado', price: 1500, category: 'Gallos' },{ name: 'Nuggets (Niños)', price: 3000, category: 'Menú Niños' },{ name: 'Mini Hamburguesa', price: 2000, category: 'Menú Niños' },{ name: 'Mini Quesadilla', price: 2000, category: 'Menú Niños' },{ name: 'Mini Sándwich', price: 2500, category: 'Menú Niños' },{ name: 'Batido en Agua', price: 1500, category: 'Bebidas' },{ name: 'Batido en Leche', price: 2000, category: 'Bebidas' },{ name: 'Pepsi 600 ml', price: 1000, category: 'Bebidas' },{ name: 'Tropical', price: 1000, category: 'Bebidas' },{ name: 'Pepsi 2.5 L', price: 1700, category: 'Bebidas' },{ name: 'Tropical 2.5 L', price: 1700, category: 'Bebidas' },{ name: 'Capuchino', price: 2500, category: 'Bebidas' },{ name: 'Café', price: 1500, category: 'Bebidas' },{ name: 'Chocolate', price: 1500, category: 'Bebidas' },{ name: 'Agua Dulce', price: 1000, category: 'Bebidas' },{ name: 'Leche', price: 1200, category: 'Bebidas' }
                    ];
                    
                    const addPromises = menuData.map(item => addDoc(menuCollection, item));
                    await Promise.all(addPromises);
                    console.log("Menu data seeded successfully.");
                }
            } catch (error) {
                console.error("Error seeding menu data:", error);
            }
        }

    </script>
</body>
</html>
