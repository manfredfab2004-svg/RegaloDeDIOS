<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurante Regalo de Dios - Sistema de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://ccodvaipvskwzbjhybxs.supabase.co/storage/v1/object/public/logos/image.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #3a3530;
            color: #4a443d;
        }
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
            color: #3a3530;
        }
        .header-bg {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(200, 180, 160, 0.5);
        }
        .container {
            max-width: 1200px;
        }
        .order-card {
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            background-color: #fffcf7;
            border-top: 1px solid rgba(255, 255, 255, 0.7);
        }
        .status-espera { border-left: 6px solid #d97706; }
        .status-visto { border-left: 6px solid #377a7f; }
        .status-listo { border-left: 6px solid #5a8b4c; }
        .status-listo .opacity-layer { opacity: 0.7; }

        .view-button {
            background-color: #e9e2d9;
            color: #6d6358;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .view-button.active {
            background-color: #8c6c52;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .view-button:hover:not(.active) {
            background-color: #dcd3c8;
        }

        .primary-btn {
            background-color: #8c6c52;
            color: white;
            transition: all 0.2s ease;
        }
        .primary-btn:hover {
            background-color: #735944;
        }
        
        #micBtn {
            background-color: #8c6c52;
            transition: all 0.2s ease;
        }
        #micBtn:hover:not(.listening) {
            background-color: #735944;
        }
        #micBtn.listening {
            background-color: #c84d4d;
            animation: pulse 1.5s infinite;
        }
        #micBtn:disabled {
            background-color: #b0a69c;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .form-panel {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .golden-text {
            color: #daa520;
            text-shadow: 0 0 5px #ffcf40, 0 0 10px #ffcf40, 0 0 15px #ffcf40;
            animation: glow-flicker 4s infinite alternate;
        }

        .watermark {
            position: fixed;
            bottom: 15px;
            right: 15px;
            font-size: 12px;
            color: #ffffff;
            opacity: 0.25;
            pointer-events: none;
            z-index: 9999;
            font-family: 'Inter', sans-serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Shake animation for wrong password */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        @keyframes glow-flicker {
            0%, 100% {
                text-shadow: 0 0 5px #ffcf40, 0 0 10px #ffcf40, 0 0 15px #ffcf40;
                opacity: 1;
            }
            50% {
                text-shadow: 0 0 8px #ffd700, 0 0 15px #ffd700, 0 0 25px #ffd700;
                opacity: 0.95;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(200, 77, 77, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(200, 77, 77, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div id="password-box" class="form-panel p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <img src="https://ccodvaipvskwzbjhybxs.supabase.co/storage/v1/object/public/logos/imagen_2025-10-07_002046501.png" alt="Logo Regalo de Dios" class="mx-auto h-24 w-24 object-contain rounded-full shadow-md mb-6">
            <h2 class="text-2xl font-bold mb-4">Ingresar Contraseña</h2>
            <p class="text-gray-600 mb-6">Por favor, introduce la contraseña para acceder al sistema.</p>
            <form id="password-form">
                <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-md text-center" placeholder="********">
                <p id="error-message" class="text-red-500 text-sm mt-2 hidden">Contraseña incorrecta.</p>
                <button type="submit" class="w-full primary-btn py-3 rounded-md text-lg font-semibold shadow-md mt-6">Acceder</button>
            </form>
        </div>
    </div>

    <div class="container mx-auto p-4 hidden">
        <header class="header-bg rounded-lg shadow-lg p-6 mb-8 text-center relative">
             <button id="logoutBtn" class="absolute top-4 right-4 bg-amber-200 text-amber-800 hover:bg-amber-300 transition-colors px-4 py-1.5 rounded-full text-sm font-semibold">Cerrar Sesión</button>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <img src="https://ccodvaipvskwzbjhybxs.supabase.co/storage/v1/object/public/logos/imagen_2025-10-07_002046501.png" alt="Logo Regalo de Dios" class="h-16 w-16 object-contain rounded-full shadow-md">
                <h1 class="text-4xl font-bold leading-tight golden-text">Restaurante Regalo de Dios</h1>
            </div>
            
            <div class="flex justify-center items-center mt-6 space-x-3">
                <button id="showCashierViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Vista Caja</button>
                <button id="showKitchenViewBtn" class="view-button px-6 py-2 rounded-full font-semibold">Vista Cocina</button>
            </div>
             <div id="auth-status" class="text-center mt-4 text-sm text-gray-500">Conectando...</div>
        </header>

        <div id="cashierView">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="lg:col-span-2 lg:sticky lg:top-8">
                    <div class="form-panel p-8 rounded-lg shadow-lg">
                        <h2 class="text-3xl font-bold mb-6 text-center text-gray-900">Crear Nuevo Pedido</h2>
                        <form id="orderForm" class="space-y-6">
                            <div>
                                <label for="tableNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Mesa</label>
                                <select id="tableNumber" required class="mt-1 block w-full bg-gray-50 border border-gray-300 text-gray-900 text-base rounded-md focus:ring-amber-500 focus:border-amber-500 p-3">
                                </select>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                     <label for="orderItems" class="block text-sm font-medium text-gray-700">Artículos del Pedido</label>
                                     <button type="button" id="micBtn" class="p-3 rounded-full primary-btn hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                             <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm5 10.126V15a1 1 0 11-2 0v-.874A6.002 6.002 0 014 9V7a1 1 0 012 0v2a4 4 0 008 0V7a1 1 0 112 0v2a6.002 6.002 0 01-4 5.126z" clip-rule="evenodd" />
                                         </svg>
                                     </button>
                                </div>
                                <textarea id="orderItems" rows="5" required class="mt-1 block p-3 w-full text-base text-gray-900 bg-gray-50 rounded-md border border-gray-300 focus:ring-amber-500 focus:border-amber-500" placeholder="Ej:\n1 Hamburguesa con queso\n1 Papas fritas\n1 Refresco grande"></textarea>
                            </div>
                            <button type="submit" class="w-full primary-btn py-3 rounded-md text-lg font-semibold shadow-md">Enviar Pedido a Cocina</button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-3">
                     <div class="form-panel p-8 rounded-lg shadow-lg">
                        <h3 class="text-3xl font-bold mb-6 text-center text-gray-900">Estado de Mesas Activas</h3>
                        <div id="cashierOrders" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <p class="text-center col-span-full text-gray-500">No hay pedidos activos.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="kitchenView" class="hidden">
             <h2 class="text-3xl font-bold mb-6 text-center text-gray-900">Pedidos Activos</h2>
            <div id="kitchenOrders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <p class="text-center col-span-full text-gray-500">Esperando pedidos...</p>
            </div>
        </div>

    </div>

    <div class="watermark hidden">Creado por Fabián Carvajal</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const passwordBox = document.getElementById('password-box');
        const errorMessage = document.getElementById('error-message');
        const mainContainer = document.querySelector('.container');
        const watermarkEl = document.querySelector('.watermark');
        const logoutBtn = document.getElementById('logoutBtn');
        
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === '1234') {
                passwordModal.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                watermarkEl.classList.remove('hidden');
            } else {
                errorMessage.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
                passwordBox.classList.add('shake');
                setTimeout(() => passwordBox.classList.remove('shake'), 500);
            }
        });
        
        passwordInput.addEventListener('input', () => {
            if (!errorMessage.classList.contains('hidden')) {
                errorMessage.classList.add('hidden');
            }
        });

        logoutBtn.addEventListener('click', () => {
            location.reload();
        });

        // Tu configuración personal de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAoJTLNCdV620Oe4s6_lqqYzVArMI3EkZQ",
            authDomain: "restaurante-regalo-de-dios.firebaseapp.com",
            projectId: "restaurante-regalo-de-dios",
            storageBucket: "restaurante-regalo-de-dios.appspot.com",
            messagingSenderId: "669926236667",
            appId: "1:669926236667:web:ff25df87d380f86cd2ab5e",
            measurementId: "G-1HPXZRCH10"
        };
        
        const collectionPath = `orders`; // Ruta simplificada para la colección

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');
        
        const authStatusEl = document.getElementById('auth-status');
        
        onAuthStateChanged(auth, user => {
             if (user) {
                authStatusEl.textContent = `Conectado como: ${user.isAnonymous ? 'Anónimo' : user.uid.substring(0, 8)}`;
                authStatusEl.classList.remove('text-red-500');
                authStatusEl.classList.add('text-green-600');
                listenToOrders();
            } else {
                authStatusEl.textContent = "No conectado. Intentando reconectar...";
                authStatusEl.classList.add('text-red-500');
            }
        });
        
        async function authenticate() {
            try {
                // En un entorno de producción como GitHub, siempre iniciaremos sesión anónimamente.
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error de autenticación:", error);
                authStatusEl.textContent = "Error de conexión.";
                authStatusEl.classList.add('text-red-500');
            }
        }
        
        const cashierView = document.getElementById('cashierView');
        const kitchenView = document.getElementById('kitchenView');
        const showCashierViewBtn = document.getElementById('showCashierViewBtn');
        const showKitchenViewBtn = document.getElementById('showKitchenViewBtn');
        const orderForm = document.getElementById('orderForm');
        const tableNumberSelect = document.getElementById('tableNumber');
        const orderItemsTextarea = document.getElementById('orderItems');
        const kitchenOrdersContainer = document.getElementById('kitchenOrders');
        const cashierOrdersContainer = document.getElementById('cashierOrders');
        const micBtn = document.getElementById('micBtn');
        
        for (let i = 1; i <= 20; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Mesa ${i}`;
            tableNumberSelect.appendChild(option);
        }

        function switchView(view) {
            if(view === 'cashier') {
                cashierView.classList.remove('hidden');
                kitchenView.classList.add('hidden');
                showCashierViewBtn.classList.add('active');
                showKitchenViewBtn.classList.remove('active');
            } else {
                cashierView.classList.add('hidden');
                kitchenView.classList.remove('hidden');
                showCashierViewBtn.classList.remove('active');
                showKitchenViewBtn.classList.add('active');
            }
        }

        showCashierViewBtn.addEventListener('click', () => switchView('cashier'));
        showKitchenViewBtn.addEventListener('click', () => switchView('kitchen'));
        
        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser) { return; }
            const tableNumber = tableNumberSelect.value;
            const items = orderItemsTextarea.value.trim().split('\n').filter(item => item);
            if (items.length === 0) { alert('Por favor, ingresa al menos un artículo para el pedido.'); return; }
            try {
                await addDoc(collection(db, collectionPath), {
                    tableNumber: parseInt(tableNumber), items: items, status: "En espera", createdAt: serverTimestamp()
                });
                orderForm.reset();
            } catch (error) { console.error("Error al añadir el pedido: ", error); }
        });

        function listenToOrders() {
            const q = query(collection(db, collectionPath), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                kitchenOrdersContainer.innerHTML = '';
                cashierOrdersContainer.innerHTML = '';

                const activeOrders = snapshot.docs.filter(doc => doc.data().status !== 'Cerrado');

                if (activeOrders.length === 0) {
                    const noOrdersMsg = '<p class="text-center col-span-full text-gray-500 p-4">No hay pedidos activos.</p>';
                    kitchenOrdersContainer.innerHTML = noOrdersMsg;
                    cashierOrdersContainer.innerHTML = noOrdersMsg;
                    return;
                }
                
                activeOrders.forEach(doc => {
                    const order = doc.data();
                    const orderId = doc.id;
                    
                    kitchenOrdersContainer.appendChild(createOrderCard(order, orderId));
                    cashierOrdersContainer.appendChild(createCashierOrderCard(order, orderId));
                });
            });
        }
        
        function createOrderCard(order, id) {
            const card = document.createElement('div');
            card.className = `order-card flex flex-col justify-between status-${order.status.toLowerCase().replace(' ', '')}`;
            
            const statusColorClasses = { "En espera": "bg-amber-100 text-amber-800", "Visto": "bg-cyan-100 text-cyan-900", "Listo": "bg-emerald-100 text-emerald-900" };
            const itemsHtml = order.items.map(item => `<li class="text-gray-700">${item}</li>`).join('');

            card.innerHTML = `
                <div class="relative p-4 ${order.status === 'Listo' ? 'opacity-layer' : ''}">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold">Mesa ${order.tableNumber}</h3>
                        <span class="text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full ${statusColorClasses[order.status]}">${order.status}</span>
                    </div>
                    <ul class="list-disc list-inside space-y-1 mb-4">${itemsHtml}</ul>
                    <p class="text-xs text-gray-500">${order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString() : 'Recibiendo...'}</p>
                </div>
                ${order.status !== 'Listo' ? `
                <div class="flex space-x-2 p-4 pt-0">
                    ${order.status === 'En espera' ? `<button data-id="${id}" data-status="Visto" class="update-status-btn flex-1 bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded-md text-sm font-semibold transition-colors">Marcar Visto</button>` : ''}
                    ${order.status === 'Visto' ? `<button data-id="${id}" data-status="Listo" class="update-status-btn flex-1 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-md text-sm font-semibold transition-colors">Marcar Listo</button>` : ''}
                </div>` : '<div class="p-4 text-center text-sm font-semibold text-green-700">Pedido completado</div>'}`;
            return card;
        }

        function createCashierOrderCard(order, id) {
            const card = document.createElement('div');
            card.className = `order-card flex flex-col justify-between status-${order.status.toLowerCase().replace(' ', '')}`;
            const statusColorClasses = { "En espera": "bg-amber-100 text-amber-800", "Visto": "bg-cyan-100 text-cyan-900", "Listo": "bg-emerald-100 text-emerald-900" };
            const itemsHtml = order.items.map(item => `<li class="text-sm text-gray-600">${item}</li>`).join('');

            card.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold">Mesa ${order.tableNumber}</h3>
                        <span class="text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full ${statusColorClasses[order.status]}">${order.status}</span>
                    </div>
                    <ul class="list-disc list-inside space-y-1 mb-4 pl-2">${itemsHtml}</ul>
                </div>
                <div class="mt-auto p-4 pt-0">
                     ${order.status === 'Listo' ? `<button data-id="${id}" data-status="Cerrado" class="close-order-btn w-full bg-emerald-600 text-white px-3 py-1.5 rounded-md hover:bg-emerald-700 text-sm font-semibold transition-colors">Cobrar y Cerrar</button>` : `<div class="text-center text-sm font-medium text-gray-500 pt-2">Pedido en ${order.status === 'En espera' ? 'espera' : 'preparación'}...</div>`}
                </div>`;
            return card;
        }
        
        kitchenOrdersContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('update-status-btn')) {
                const id = e.target.dataset.id;
                const newStatus = e.target.dataset.status;
                try {
                    await updateDoc(doc(db, collectionPath, id), { status: newStatus });
                } catch (error) { console.error("Error al actualizar el estado: ", error); }
            }
        });

        cashierOrdersContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('close-order-btn')) {
                const id = e.target.dataset.id;
                try {
                    await updateDoc(doc(db, collectionPath, id), { status: "Cerrado" });
                } catch (error) { console.error("Error al cerrar el pedido: ", error); }
            }
        });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isListening = false;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true; recognition.lang = 'es-CR'; recognition.interimResults = false;
            
            micBtn.addEventListener('click', () => { 
                if (isListening) { recognition.stop(); } else { recognition.start(); }
            });

            recognition.onstart = () => { isListening = true; micBtn.classList.add('listening'); };
            recognition.onend = () => { isListening = false; micBtn.classList.remove('listening'); };
            recognition.onerror = (event) => { 
                console.error('Error en reconocimiento de voz:', event.error); 
                isListening = false; 
                micBtn.classList.remove('listening'); 
                alert('Hubo un error con el reconocimiento de voz. Asegúrate de haber dado permisos y que tu micrófono funcione.');
            };
            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                     if (event.results[i].isFinal) { transcript += event.results[i][0].transcript.trim() + '\n'; }
                }
                if (transcript) { orderItemsTextarea.value += transcript; }
            };
        } else {
            console.warn("El reconocimiento de voz no es compatible con este navegador.");
            micBtn.disabled = true;
            micBtn.title = "El reconocimiento de voz no está disponible en este navegador. Recomendamos Google Chrome o Microsoft Edge.";
        }

        switchView('cashier');
        authenticate();
    </script>
</body>
</html>



